//===========================================================================
// Program ID...: LegalDiary
// Author.......: Francois De Bruin Meyer
// Copyright....: BlueCrane Software Development CC
// Date.........: 10 January 2011
//---------------------------------------------------------------------------
// Description..: First Run Utility
//---------------------------------------------------------------------------
// Changes......:
//===========================================================================

//---------------------------------------------------------------------------
// Include statements
//---------------------------------------------------------------------------
#include <vcl.h>
#include <stdio.h>
#include "Strutils.hpp";
#include "Registry.hpp"
#pragma hdrstop

#include "LPMS_FirstRunApp.h"
#include "LPMS_KeyH.h"
#include "LPMS_Decode.h"
#include "LPMS_FirstRunMultiCpy.h"
#include "LPMS_FirstRunldSelDB.h"
#include "LPMS_InputQueryM.h"

//---------------------------------------------------------------------------
// Autogenerated statements
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "AdvSpin"
#pragma link "AdvDirectoryEdit"
#pragma link "AdvEdBtn"
#pragma link "AdvEdit"
#pragma link "AdvFileNameEdit"
#pragma link "JvCipher"
#pragma link "JvComponentBase"
#pragma resource "*.dfm"

//---------------------------------------------------------------------------
//Global Definitions
//---------------------------------------------------------------------------
#define SERVER_DELIM   '|'
#define BUFFER_LEN    1024
#define TYPE_READ        1
#define TYPE_WRITE       2
#define TYPE_PLAIN       1
#define TYPE_CODED       2
#define TYPE_SELECT      1
#define TYPE_OTHER       2
#define TYPE_PASSWORD    1
#define TYPE_TEXT        2
#define TYPE_ARCHIVE     1
#define TYPE_CURRENT     2
#define LINE_TABLE       0
#define IM_UNREAD        1
#define CYPHER_ENC       0
#define CYPHER_DEC       1

//--- Temporary - Allow both old style encoding and new style encoding but
//--- only one type at a time

//#define NEW_ENCODING

TFLPMS_FirstRunApp *FLPMS_FirstRunApp;

//---------------------------------------------------------------------------
// Constructor
//---------------------------------------------------------------------------
__fastcall TFLPMS_FirstRunApp::TFLPMS_FirstRunApp(TComponent* Owner)
   : TForm(Owner)
{
   LockS_State = LockC_State = LockU_State = LockD_State = LockB_State = true;
   LockL_State = Proceed = true;
   MultiCompany = BackSpace = Registered = SearchBoth = SearchUser = false;
   SearchDesc = Sema = false;
   DBPrefix = "invalid";

   ThisPass = "BlueCrane Software Development CC";

   LogList = new TStringList;

//--- Check whether MultiCompany is set and get the values that are not Multi
//--- Company dependant

   FLPMS_FirstRunMultiCpy = new TFLPMS_FirstRunMultiCpy(Application);
   FLPMS_FirstRunMultiCpy->ShowModal();
   delete FLPMS_FirstRunMultiCpy;

   if (Proceed == false)
      Application->Terminate();
}

//---------------------------------------------------------------------------
// Remove the custom hook that was used to trap the BackSpace key
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::FormDestroy(TObject *Sender)
{
   if (Registered)
   {
      UnregisterHotKey(FLPMS_FirstRunApp->Handle,1);
      Registered = false;
   }

   delete LogList;

   if (CallHWND != 0)
      ShowWindow((void *)CallHWND,SW_SHOW);
}

//---------------------------------------------------------------------------
// Custom Handler to trap the BackSpace Key when pressed
//---------------------------------------------------------------------------
MESSAGE void __fastcall TFLPMS_FirstRunApp::WMHotKey(TWMHotKey &Message)
{
   INPUT ip;

   if (edtKeyM->Focused() == false)
   {
      if (Registered)
      {
         UnregisterHotKey(FLPMS_FirstRunApp->Handle,1);
         Registered = BackSpace = false;
      }

//--- Simulate a backspace as it gets lost in the process of trapping it and
//--- then not acting on it

      ip.type = INPUT_KEYBOARD;
      ip.ki.time = 0;
      ip.ki.dwFlags = KEYEVENTF_UNICODE;
      ip.ki.wScan = VK_BACK;
      ip.ki.wVk = 0;

      ip.ki.dwExtraInfo = 0;
      SendInput(1, &ip, sizeof(INPUT));

      return;
   }

   BackSpace = true;

   if (edtKeyM->SelLength == edtKeyM->Text.Length())
      edtKeyM->Text = "";
   else
      edtKeyM->Text = edtKeyM->Text.SubString(1,edtKeyM->Text.Length() - 1);

   edtKeyM->SelStart = edtKeyM->Text.Length();

   if ((edtPrefixM->Text != "") && (edtKeyM->Text != ""))
      btnProcessM->Enabled = true;
   else
      btnProcessM->Enabled = false;
}

//---------------------------------------------------------------------------
// User entered the edtKeyM field
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtKeyMEnter(TObject *Sender)
{
   if (Registered == false)
   {
      Registered = RegisterHotKey(FLPMS_FirstRunApp->Handle,1,0,VK_BACK);

      if (Registered == false)
         ShowMessage("WARNING: Failed to register VK_BACK as a Hotkey");
   }
}

//---------------------------------------------------------------------------
// Executed before the Form is displayed
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::FormActivate(TObject *Sender)
{
   int               idx1;
   bool              ParmsFound = true;
   AnsiString        ThisPassPhrase = "";
   LPMS_Key_Rec     *This_Key_Rec;
   TRegistryIniFile *RegIni;
   TStringList      *Options, *Params;

//--- Set up the Registry string subject to the value of MultiCompany

   if (MultiCompany == true)
      KeepRegString = "Software\\BlueCrane Software\\LPMS 3\\" + ThisDBPrefix;
   else
      KeepRegString = "Software\\BlueCrane Software\\LPMS 3";

//--- Extract current values from the Registry

	RegIni = new TRegistryIniFile(KeepRegString);

   edtSQLFile->Text = RegIni->ReadString("Preferences","SQLLocation","");
   UserKey          = RegIni->ReadString("Preferences","Key","");
   ServerName       = RegIni->ReadString("Preferences","KeyHost","");
   ServerPort       = RegIni->ReadString("Preferences","KeyPort","");
   LPMSUpgrade      = RegIni->ReadString("Preferences","LPMSUpgrade",ExtractFilePath(Application->ExeName) + "LPMS_Upgrade.exe");
   DBPrefix         = RegIni->ReadString("Preferences","DBPrefix","invalid");

   delete RegIni;

//--- Check whether any arguments were passed and retrieve if so

   Options = new TStringList;
   Params  = new TStringList;

   CallHWND = 0;

   if (ldOpt(_argc, _argv, "G:M:P:H:", Options, Params) > 0)
   {

      for (idx1 = 0; idx1 < Options->Count; idx1++)
      {
         if (Options->Strings[idx1] == "G")              // GUID for LPMS
            ThisGUID = Params->Strings[idx1];

         if (Options->Strings[idx1] == "M")              // Full path to "setup.exe" for new version
            ThisInstall = Params->Strings[idx1];

         if (Options->Strings[idx1] == "P")              // Passphrase to run FirstRun - required
            ThisPassPhrase = Params->Strings[idx1];

         if (Options->Strings[idx1] == "H")              // Hide and Show the callers Form
         {
            CallHWND = StrToInt(Params->Strings[idx1]);
            if (CallHWND != 0)
               ShowWindow((void *)CallHWND,SW_HIDE);
         }
      }
   }
   else
      ParmsFound = false;

   delete Options;
   delete Params;

//--- Attempt a silent uninstall and upgrade of LPMS if both GUID and Setup
//--- location was passed as parameters

   if (ParmsFound == true && (ThisGUID != "" && ThisInstall != "") && ThisPassPhrase == ThisPass)
   {
      SilentUpgrade();
      Application->Terminate();
      return;
   }

//--- If we get here then no/insufficient/invalid parameters were passed.
//--- Check whether this user is already registered

   if (UserKey == "** Not Registered **")
   {
      pgTabs->Pages[0]->Visible = true;
      pgTabs->Pages[1]->Visible = false;
      pgTabs->Pages[2]->Visible = false;
      pgTabs->Pages[3]->Visible = false;
      pgTabs->Pages[4]->Visible = false;
      pgTabs->ActivePageIndex   = 0;
   }
   else
   {
      pgTabs->Pages[0]->Visible = false;
      pgTabs->Pages[1]->Visible = false;
      pgTabs->Pages[2]->Visible = true;
      pgTabs->Pages[3]->Visible = false;
      pgTabs->Pages[4]->Visible = false;
      pgTabs->ActivePageIndex   = 2;
   }

//--- Display the landing tab

   pgTabsChange(Sender);

//--- Set some default values

   btnRegister->Enabled = False;
   btnProcessF->Enabled = False;
   btnProcessM->Enabled = False;
   btnUpgradeU->Enabled = False;

//--- Retrieve this PC's Mac Addresses (Up to 6)

   This_Key_Rec  = new LPMS_Key_Rec;
   DldDecode->LPMS_Key_GetUnique(This_Key_Rec);

   if (This_Key_Rec->MacAddress[0] == "")
   {
      MessageBox(NULL,"Unable to find a valid MACAddress - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      delete This_Key_Rec;
      Application->Terminate();
      return;
   }
   else
      edtUnique->Text = This_Key_Rec->MacAddress[0];

   delete This_Key_Rec;
}

//---------------------------------------------------------------------------
// User changed to a different Tab
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::pgTabsChange(TObject *Sender)
{
   int         idx;
   TListItem  *ThisList;

//--- Reset the information on the Setup tab for safety reasons

   if (pgTabs->ActivePageIndex != 1)
      LockS_State = true;

//--- Reset the information on the Convert tab for safety reasons

   if (pgTabs->ActivePageIndex != 3)
   {
      LockC_State = true;
      edtCurrVersion->Clear();
      stProgress->Caption = "";
      StaticText3->Caption = "LPMS First Run Utility: Enter the information below then click on the [Get] button to retrieve the current Data Base version";
   }

//--- Reset the information on the Upgrade tab for safety reasons

   if (pgTabs->ActivePageIndex != 4)
   {
      LockU_State = true;
      lvAlpha->Clear();
      lvNumeric->Clear();
      lvExclude->Clear();
      rbSilent->Checked  = false;
      rbSave->Checked    = false;
      rbRestore->Checked = false;
      cbPersist->Checked = false;
      cbIgnore->Checked  = false;
      cbDebug->Checked   = false;
      edtFolder->Clear();
      edtRoot->Clear();
      edtSubkey->Clear();
      edtSetupLoc->Clear();
   }

//--- Reset the information on the SQL tab for safety reasons

   if (pgTabs->ActivePageIndex != 5)
   {
      LockD_State = true;
      StaticText6->Caption = "LPMS First Run Utility: Enter the database information below together with a valid SQL statement then click on 'Process'";
   }

//--- Reset the information on the Restore tab for safety reasons

   if (pgTabs->ActivePageIndex != 6)
   {
      LockB_State = true;
      edtBackupFile->Clear();
      edtBackupFile->ReadOnly = true;
      rbFull->Checked = false;
      rbPartial->Checked = false;
      cbType->Checked = false;
      edtTitle->Clear();
      edtDate->Clear();
      edtMode->Clear();
      edtVersion->Clear();
      edtTime->Clear();
      edtType->Clear();
      stMsgB->Caption = "LPMS First Run Utility: Enter or select the backup file to restore then select the required options before clicking on 'Restore'";
   }

//--- Reset the information on the Log Display tab for safety reasons

   if (pgTabs->ActivePageIndex != 7)
   {
      LockL_State = true;
      edtUserL->Clear();
      edtPasswordL->Clear();
      edtHostL->Clear();
      edtArchive->Clear();
      edtSearchUser->Clear();
      edtSearchDesc->Clear();
      chkMatchAny->Checked = false;
      edtUser->Clear();
      edtDateL->Clear();
      edtTimeL->Clear();
      edtDescriptionL->Clear();
      lvLog->Clear();
      chkAutoRefresh->Checked = false;
      speInterval->Value = 60;
      stMsgL->Caption = "LPMS First Run Utility: Provide a valid 'User', 'Password' and 'Host' then click on 'Current Log' or select a Log Archive then click on 'Load' to display the contents";
   }

//--- Remove the hook to trap the backspace key

   if (Registered)
   {
      UnregisterHotKey(FLPMS_FirstRunApp->Handle,1);
      Registered = false;
   }

//--- Set up the tab selected by the user

   if (pgTabs->ActivePageIndex == 0)
   {
      edtKey->Text = UserKey;
#ifdef NEW_ENCODING
      edtPrefix->Text = Vignere(CYPHER_DEC,DBPrefix.SubString(1,6).c_str(),ThisPass.c_str());
#else
      edtPrefix->Text = jvCipher->DecodeString(ThisPass,DBPrefix.SubString(1,6));
#endif
      edtNameChange(Sender);
      btnRegister->Default = true;
      btnCancelR->Caption  = "Cancel";
      btnCancelR->Default  = false;
      edtName->SetFocus();
   }
   else if (pgTabs->ActivePageIndex == 1)
   {
#ifdef NEW_ENCODING
      edtPrefixF->Text = Vignere(CYPHER_DEC,DBPrefix.SubString(1,6).c_str(),ThisPass.c_str());
#else
      edtPrefixF->Text = jvCipher->DecodeString(ThisPass,DBPrefix.SubString(1,6));
#endif

      if (LockS_State == true)
      {
         btnLockS->Visible   = true;
         btnUnlockS->Visible = false;

         edtHostName->Enabled = false;
         edtUserName->Enabled = false;
         edtPassword->Enabled = false;
         edtSQLFile->Enabled  = false;
         edtCpyName->Enabled  = false;
         edtPrefixF->Enabled  = false;

         btnProcessF->Enabled = false;
         btnProcessF->Default = false;
         btnCancelF->Caption  = "Cancel";
         btnCancelF->Default  = true;
      }
      else
      {
         btnLockS->Visible   = false;
         btnUnlockS->Visible = true;

         edtHostName->Enabled = true;
         edtUserName->Enabled = true;
         edtPassword->Enabled = true;
         edtSQLFile->Enabled  = true;
         edtCpyName->Enabled  = true;
         edtPrefixF->Enabled  = true;

         edtHostNameChange(Sender);

         btnProcessF->Default = true;
         btnCancelF->Caption  = "Cancel";
         btnCancelF->Default  = false;

         edtHostName->SetFocus();
      }
   }
   else if (pgTabs->ActivePageIndex == 2)
   {
//--- Pre-populate the display fields

#ifdef NEW_ENCODING
      edtPrefixM->Text = Vignere(CYPHER_DEC,DBPrefix.SubString(1,6).c_str(),ThisPass.c_str());
#else
      edtPrefixM->Text = jvCipher->DecodeString(ThisPass,DBPrefix.SubString(1,6));
#endif

      edtKeyM->Text = UserKey;
      btnProcessM->Enabled = false;
      edtPrefixMChange(Sender);
      btnProcessM->Default = true;
      btnCancelM->Caption  = "Cancel";
      btnCancelM->Default  = false;
      edtPrefixM->SetFocus();
   }
   else if (pgTabs->ActivePageIndex == 3)
   {
#ifdef NEW_ENCODING
      edtPrefixC->Text = Vignere(CYPHER_DEC,DBPrefix.SubString(1,6).c_str(),ThisPass.c_str());
#else
      edtPrefixC->Text = jvCipher->DecodeString(ThisPass,DBPrefix.SubString(1,6));
#endif

      edtNewVersion->Text = "3.2.1";
      stProgress->Caption = "";

      if (LockC_State == true)
      {
         btnLockC->Visible   = true;
         btnUnlockC->Visible = false;

         edtHostNameC->Enabled   = false;
         edtUserNameC->Enabled   = false;
         edtPasswordC->Enabled   = false;
         edtPrefixC->Enabled     = false;
         edtCurrVersion->Enabled = false;
         edtNewVersion->Enabled  = false;

         btnGet->Enabled     = false;

         btnProcessC->Enabled = false;
         btnProcessC->Default = false;
         btnCancelC->Caption  = "Cancel";
         btnCancelC->Default  = true;
      }
      else
      {
         btnLockC->Visible   = false;
         btnUnlockC->Visible = true;

         edtHostNameC->Enabled   = true;
         edtUserNameC->Enabled   = true;
         edtPasswordC->Enabled   = true;
         edtPrefixC->Enabled     = true;
         edtCurrVersion->Enabled = true;
         edtNewVersion->Enabled  = true;

         btnGet->Enabled     = true;
         edtHostNameCChange(Sender);

         btnProcessC->Default = true;
         btnCancelC->Caption  = "Cancel";
         btnCancelC->Default  = false;

         edtHostNameC->SetFocus();
      }
   }
   else if (pgTabs->ActivePageIndex == 4)
   {
      cbPersist->Checked = false;
      cbIgnore->Checked  = false;
      cbDebug->Checked   = false;

      btnUpgradeU->Enabled = false;

      if (LockU_State == true)
      {
         btnLockU->Visible   = true;
         btnUnlockU->Visible = false;

         lvAlpha->Enabled     = false;
         lvNumeric->Enabled   = false;
         lvExclude->Enabled   = false;
         rbSilent->Enabled    = false;
         rbSave->Enabled      = false;
         rbRestore->Enabled   = false;
         cbPersist->Enabled   = false;
         cbIgnore->Enabled    = false;
         cbDebug->Enabled     = false;
         edtFolder->Enabled   = false;
         edtRoot->Enabled     = false;
         edtSubkey->Enabled   = false;
         edtSetupLoc->Enabled = false;

         btnUpgradeU->Enabled = false;
         btnUpgradeU->Default = false;
         btnCancelU->Caption  = "Cancel";
         btnCancelU->Default  = true;
      }
      else
      {
         btnLockU->Visible   = false;
         btnUnlockU->Visible = true;

         lvAlpha->Enabled     = true;
         lvNumeric->Enabled   = true;
         lvExclude->Enabled   = true;
         rbSilent->Enabled    = true;
         rbSave->Enabled      = true;
         rbRestore->Enabled   = true;
         cbPersist->Enabled   = true;
         cbIgnore->Enabled    = true;
         cbDebug->Enabled     = true;
         edtFolder->Enabled   = true;
         edtRoot->Enabled     = true;
         edtSubkey->Enabled   = true;
         edtSetupLoc->Enabled = true;

         btnUpgradeU->Default = true;
         btnCancelU->Caption  = "Cancel";
         btnCancelU->Default  = false;

         for (idx = 0; idx < 49; idx++)
         {
            ThisList = lvAlpha->Items->Add();
            ThisList->Caption = "";

            ThisList = lvNumeric->Items->Add();
            ThisList->Caption = "";

            ThisList = lvExclude->Items->Add();
            ThisList->Caption = "";
         }

         edtFolder->Text = "C:\\";
         edtRoot->Text   = "Software\\BlueCrane Software\\LPMS 3";
         edtSubkey->Text = "Preferences";
      }
   }
   else if (pgTabs->ActivePageIndex == 5)
   {
      Query1->Close();
      btnProcessD->Enabled = false;

      if (LockD_State == true)
      {
         btnLockD->Visible   = true;
         btnUnlockD->Visible = false;

         edtHostNameD->Enabled = false;
         edtUserNameD->Enabled = false;
         edtPasswordD->Enabled = false;
         edtSQLD->Enabled      = false;

         btnProcessD->Enabled = false;
         btnProcessD->Default = false;
         btnCancelD->Caption  = "Cancel";
         btnCancelD->Default  = true;
      }
      else
      {
         btnLockD->Visible   = false;
         btnUnlockD->Visible = true;

         edtHostNameD->Enabled = true;
         edtUserNameD->Enabled = true;
         edtPasswordD->Enabled = true;
         edtSQLD->Enabled      = true;

         btnProcessD->Default = true;
         btnCancelD->Caption  = "Cancel";
         btnCancelD->Default  = false;

         edtHostNameD->SetFocus();
      }
   }
   else if (pgTabs->ActivePageIndex == 6)
   {
      rbFull->Checked      = true;
      cbType->Checked      = false;
      btnProcessB->Enabled = false;
      btnAllB->Enabled     = false;
      lvTables->Enabled    = false;
      Selected             = true;

      if (LockB_State == true)
      {
         btnLockB->Visible   = true;
         btnUnlockB->Visible = false;
         btnAllB->Enabled     = false;

         edtBackupFile->Enabled = false;
         btnOpenB->Enabled      = false;
         btnAllB->Enabled       = false;
         edtTitle->Enabled      = false;
         edtDate->Enabled       = false;
         edtTime->Enabled       = false;
         edtVersion->Enabled    = false;
         edtMode->Enabled       = false;
         edtType->Enabled       = false;
         rbFull->Enabled        = false;
         rbPartial->Enabled     = false;
         cbType->Enabled        = false;
         rbFull->Checked        = false;
         rbPartial->Checked     = false;
         cbType->Checked        = false;

         btnProcessB->Enabled = false;
         btnProcessB->Default = false;
         btnCancelB->Caption  = "Cancel";
         btnCancelB->Default  = true;
      }
      else
      {
         btnLockB->Visible   = false;
         btnUnlockB->Visible = true;

         edtBackupFile->Enabled = true;
         btnOpenB->Enabled      = true;

//         btnProcessB->Default = true;
//         btnCancelB->Caption  = "Cancel";
//         btnCancelB->Default  = false;

         edtBackupFile->SetFocus();
      }
   }
   else if (pgTabs->ActivePageIndex == 7)
   {
      edtArchive->Clear();
      edtSearchUser->Clear();
      edtSearchDesc->Clear();
      chkMatchAny->Checked    = false;
      edtUser->Clear();
      edtDateL->Clear();
      edtTimeL->Clear();
      edtDescriptionL->Clear();
      lvLog->Clear();
      stMsg->Caption          = "0 Records";
      chkAutoRefresh->Checked = false;
      speInterval->Value      = 60;
      btnOpenLog->Enabled     = false;

      btnLockL->Visible   = true;
      btnUnlockL->Visible = false;

      dtpSDate->Enabled  = false;
      dtpSTime->Enabled  = false;
      dtpEDate->Enabled  = false;
      dtpETime->Enabled  = false;
      btnReload->Enabled = false;

      edtSearchUser->Enabled = false;
      btnSearchUser->Enabled = false;
      edtSearchDesc->Enabled = false;
      btnSearchDesc->Enabled = false;
      btnSearchBoth->Enabled = false;
      chkMatchAny->Enabled   = false;

      btnFirst->Enabled = false;
      btnPrev->Enabled  = false;
      btnNext->Enabled  = false;
      btnLast->Enabled  = false;

      lvLog->Enabled          = false;
      chkAutoRefresh->Enabled = false;
      speInterval->Enabled    = false;

      btnProcessL->Enabled = false;

      btnAll->Enabled     = false;
      btnArchive->Enabled = false;

      DateIsSet = ArchiveActive = false;
      edtUserL->SetFocus();
   }
}

//===========================================================================
//===
//=== Register Page functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User clicked on the Register button on the Register Page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnRegisterClick(TObject *Sender)
{
   AnsiString  Response, PlainReq, CodedReq;

   if (edtName->Text == "")
   {
      MessageBox(NULL,"Name is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtName->SetFocus();
      return;
   }

   if (edtEmail->Text == "")
   {
      MessageBox(NULL,"Email is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtEmail->SetFocus();
      return;
   }

   if (edtNum->Text == "")
   {
      MessageBox(NULL,"Contact Num is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtNum->SetFocus();
      return;
   }

   if (edtCompany->Text == "")
   {
      MessageBox(NULL,"Company is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtCompany->SetFocus();
      return;
   }

//--- Connect to the Server and request registration

   tcpClient->Disconnect();
   tcpClient->Host = ServerName;
   tcpClient->Port = StrToInt(ServerPort);
   tcpClient->Connect();

//--- Identify ourselves to the Server and get the Server's response

   tcpClient->IOHandler->WriteLn("LPMS Server Request");
   Response = tcpClient->IOHandler->ReadLn();

   if (Response == "LPMS Server Ready")
   {
      PlainReq = "4|" + edtName->Text + "|" + edtEmail->Text + "|" + edtNum->Text + "|" + edtCompany->Text + "|" + edtUnique->Text + "|" + edtPrefix->Text + "|";
      CodedReq - Vignere(CYPHER_ENC,PlainReq.c_str(),ThisPass.c_str());
      tcpClient->IOHandler->WriteLn(CodedReq);
      Response = tcpClient->IOHandler->ReadLn();
      ProcessResponse(Response);
   }
   else
   {
      MessageBox(NULL,AnsiString("Unexpected or invalid response from Server: '" + Response + "'").c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      tcpClient->Disconnect();
      return;
   }

//--- Wrap it up

   tcpClient->Disconnect();

   btnRegister->Default = false;
   btnCancelR->Caption  = "Close";
   btnCancelR->Default  = true;
   btnCancelR->SetFocus();
}

//---------------------------------------------------------------------------
// A field on the Registration Page changed
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtNameChange(TObject *Sender)
{
   int  FldCount = 0;

   if (edtName->Text != "")    FldCount++;
   if (edtEmail->Text != "")   FldCount++;
   if (edtNum->Text != "")     FldCount++;
   if (edtCompany->Text != "") FldCount++;

   if (FldCount == 4)
      btnRegister->Enabled = true;
   else
      btnRegister->Enabled = false;
}

//===========================================================================
//===
//=== Set-up Page functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User clicked on the Process button on the Set-up Page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnProcessFClick(TObject *Sender)
{
   bool              PartValid;
   int               idx1;
   AnsiString        PartOne, PartTwo, S1, T1, T2;
   TStringList      *SQLList;
   TRegistryIniFile *RegIni;

   if (edtHostName->Text == "")
   {
      MessageBox(NULL,"Host Name is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtHostName->SetFocus();
      return;
   }

   if (edtUserName->Text == "")
   {
      MessageBox(NULL,"User Name is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtUserName->SetFocus();
      return;
   }

   if (edtPassword->Text == "")
   {
      MessageBox(NULL,"Password is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtPassword->SetFocus();
      return;
   }

   if (edtSQLFile->Text == "")
   {
      MessageBox(NULL,"SQL File is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtSQLFile->SetFocus();
      return;
   }

   if (edtCpyName->Text == "")
   {
      MessageBox(NULL,"Company Name is a required field - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtCpyName->SetFocus();
      return;
   }

//--- Make sure that Prefix contains exactly 6 characters with the first 3 alpa
//---   and the last three numeric

   if (edtPrefixF->Text.Length() != 6)
   {
      MessageBox(NULL,"Prefix is invalid. A valid Prefix is 6 characters in length and consists of 3 Alphabetic characters followed by 3 Numeric characters. Please provide a valid Prefix","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtPrefixF->SetFocus();
      return;
   }

   PartOne   = edtPrefixF->Text.SubString(1,3);
   PartTwo   = edtPrefixF->Text.SubString(4,3);
   PartValid = true;

   for (idx1=1; idx1<=3; idx1++)
   {
      if ((PartOne[idx1] >= 'A' && PartOne[idx1] <= 'Z') || (PartOne[idx1] >= 'a' && PartOne[idx1] <= 'z'))
         continue;
      else
         PartValid = false;
   }

   for (idx1=1; idx1<=3; idx1++)
   {
      if (PartTwo[idx1] >= '0' && PartTwo[idx1] <= '9')
         continue;
      else
         PartValid = false;
   }

   if (PartValid == false) {
      MessageBox(NULL,"Prefix is invalid. A valid Prefix is 6 characters in length and consists of 3 Alphabetic characters followed by 3 Numeric characters. Please provide a valid Prefix","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtPrefixF->SetFocus();
      return;
   }

//--- Warn the user that this action will utterly destroy any existing database

   if (MessageBox(NULL,AnsiString("WARNING: This action will completely destroy any existing LPMS database for '" + edtPrefixF->Text + "' in '" + edtHostName->Text + "' and cannot be undone without a valid backup.\n\nClick [OK] to proceed or [Cancel] to cancel this action").c_str(),"Legal Practise Management System - FirstRun",(MB_OKCANCEL|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_CANCEL)
      return;

//--- User wants to proceed

   HostName = edtHostName->Text;
   Prefix   = edtPrefixF->Text;
   SQLFile  = edtSQLFile->Text;

//--- Open a connection to the datastore named in HostName

   CSMySQL = "Provider=MSDASQL.1;Persist Security Info=False;Data Source=BSD_MySQL;User ID=" + edtUserName->Text + ";Password=" + edtPassword->Text + ";Server=";

   if ((DM_Open_Connection()) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Start by creating the Database

   S1 = "DROP DATABASE IF EXISTS " + Prefix + "_LPMS";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Information message: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));
   }

   S1 = "CREATE DATABASE " + Prefix + "_LPMS";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Define the default LPMS user for both local and remote access

   S1 = "DROP USER '" + Prefix + "_LD'@'localhost'";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
    {
      MessageBox(NULL,AnsiString("Information message: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));
   }

   S1 = "CREATE USER '" + Prefix + "_LD'@'localhost' IDENTIFIED BY 'LD01'";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

   S1 = "GRANT SELECT, INSERT, UPDATE, DELETE ON " + Prefix + "_LPMS.* TO '" + Prefix + "_LD'@'localhost'";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

   S1 = "DROP USER '" + Prefix + "_LD'@'%'";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Information message: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));
   }

   S1 = "CREATE USER '" + Prefix + "_LD'@'%' IDENTIFIED BY 'LD01'";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

   S1 = "GRANT SELECT, INSERT, UPDATE, DELETE ON " + Prefix + "_LPMS.* TO '" + Prefix + "_LD'@'%'";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Create the tables

   S1 = "USE " + Prefix + "_LPMS";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

   SQLList = new TStringList;
   SQLList->LoadFromFile(SQLFile);

   for (idx1=0; idx1<SQLList->Count;idx1++)
   {
      if (SQLList->Strings[idx1][1] == '#')
         continue;

      if (SQLList->Strings[idx1][1] == '1')
      {
         if (DM_Put_DB(SQLList->Strings[idx1].SubString(2,SQLList->Strings[idx1].Length() - 1),TYPE_OTHER) == false)
         {
            MessageBox(NULL,AnsiString("Information message: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));
         }
      }
      else
      {
         if (DM_Put_DB(SQLList->Strings[idx1].SubString(2,SQLList->Strings[idx1].Length() - 1),TYPE_SELECT) == false)
         {
            MessageBox(NULL,AnsiString("Information message: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));
         }
      }
   }

//--- Write the LPMS Signature to the Database

   if (DM_PutSignature() == false)
      return;

//--- Insert the values of HostName, DBPrefix and LastUser into the Registry

   ShortDateFormat = "yyyy/MM/dd";
   DateSeparator   = '/';

//--- Write the new values to the Registry

#ifdef NEW_ENCODING
   DBPrefix = Vignere(CYPHER_ENC,AnsiString(edtPrefixF->Text + FormatDateTime("yyyy/mm/dd",Now())).c_str(),ThisPass.c_str());
   T1 = DBPrefix.SubString(1,6);
   T2 = DBPrefix.SubString(7,99);
   DBPrefix = T1 + EncodePass(T2);
#else
   DBPrefix = jvCipher->EncodeString(ThisPass,(edtPrefixF->Text + FormatDateTime("yyyy/mm/dd",Now())));
#endif

//	RegIni = new TRegistryIniFile("Software\\BlueCrane Software\\LPMS 3");
	RegIni = new TRegistryIniFile(KeepRegString);

   RegIni->WriteString("Preferences","HostName",edtHostName->Text);
   RegIni->WriteString("Preferences","DBPrefix",DBPrefix);
   RegIni->WriteString("Preferences","LastUser","Administrator");

   delete RegIni;

//--- Wrap it up

   MessageBox(NULL,"Set-up successfully completed...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));

   btnProcessF->Default = false;
   btnCancelF->Caption  = "Close";
   btnCancelF->Default  = true;
   btnCancelF->SetFocus();
}

//---------------------------------------------------------------------------
// User Clicked on the Lock at the bottom of the Set-up screen
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnUnlockSClick(TObject *Sender)
{
   UnicodeString Password;

   if (LockS_State == true)
   {
//      InputQuery("Legal Practise Management System","Pass phrase:",Password);
      Password = InputQueryM("Legal Practise Management System","Pass phrase:",TYPE_PASSWORD);

      if (Password == ThisPass)
         LockS_State = false;
   }
   else
      LockS_State = true;

   pgTabsChange(Sender);
}

//---------------------------------------------------------------------------
// A Field on the Set-up Page changed
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtHostNameChange(TObject *Sender)
{
   int  FldCount = 0;

   if (edtHostName->Text != "") FldCount++;
   if (edtUserName->Text != "") FldCount++;
   if (edtPassword->Text != "") FldCount++;
   if (edtCpyName->Text != "")  FldCount++;

   if (FldCount == 4)
      btnProcessF->Enabled = true;
   else
      btnProcessF->Enabled = false;
}

//---------------------------------------------------------------------------
// User clicked on the embedded button in the SQL File field
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtSQLFileClickBtn(TObject *Sender)
{
   edtSQLFile->Filter      = "SQL Text Files (*.txt)|*.txt|SQL Files (*.sql)|*.sql|All Files (*.*)|*.*";
   edtSQLFile->DefaultExt  = ".txt";
   edtSQLFile->FilterIndex = 1;
}

//===========================================================================
//===
//=== Maintenance Page functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User clicked on the in-line button to clear the Key field
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtKeyMClickBtn(TObject *Sender)
{
   edtKeyM->Clear();
   edtKeyM->SetFocus();
}

//---------------------------------------------------------------------------
// User clicked on the Update button on the Maintenance Page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnProcessMClick(TObject *Sender)
{
   bool              PartValid;
   int               idx1;
   AnsiString        PartOne, PartTwo, T1, T2;
   TRegistryIniFile *RegIni;

   if (edtPrefixM->Text.Length() != 6)
   {
      MessageBox(NULL,"Prefix is invalid. A valid Prefix is 6 characters in length and consists of 3 Alphabetic characters followed by 3 Numeric characters. Please provide a valid Prefix","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtPrefixM->SetFocus();
      return;
   }

   PartOne   = edtPrefixM->Text.SubString(1,3);
   PartTwo   = edtPrefixM->Text.SubString(4,3);
   PartValid = true;

   for (idx1=1; idx1<=3; idx1++)
   {
      if ((PartOne[idx1] >= 'A' && PartOne[idx1] <= 'Z') || (PartOne[idx1] >= 'a' && PartOne[idx1] <= 'z'))
         continue;
      else
         PartValid = false;
   }


   for (idx1=1; idx1<=3; idx1++)
   {
      if (PartTwo[idx1] >= '0' && PartTwo[idx1] <= '9')
         continue;
      else
         PartValid = false;
   }

   if (PartValid == false)
   {
      MessageBox(NULL,"Prefix is invalid. A valid Prefix is 6 characters in length and consists of 3 Alphabetic characters followed by 3 Numeric characters. Please provide a valid Prefix","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtPrefixM->SetFocus();
      return;
   }

   if ((edtKeyM->Text == "") || (edtKeyM->Text.Length() != 38))
   {
      MessageBox(NULL,"Key is a required field and must be exactly 38 characters long - Please provide","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      edtKeyM->SetFocus();
      return;
   }

//--- Update the value of DBPrefix and Key in the Registry

   ShortDateFormat = "yyyy/MM/dd";
   DateSeparator   = '/';

#ifdef NEW_ENCODING
   DBPrefix = Vignere(CYPHER_ENC,AnsiString(edtPrefixM->Text + FormatDateTime("yyyy/mm/dd",Now())).c_str(),ThisPass.c_str());
   T1 = DBPrefix.SubString(1,6);
   T2 = DBPrefix.SubString(7,99);
   DBPrefix = T1 + EncodePass(T2);
#else
   DBPrefix = jvCipher->EncodeString(ThisPass,(edtPrefixM->Text + FormatDateTime("yyyy/mm/dd",Now())));
#endif

   UserKey  = edtKeyM->Text;

//--- Write the new values to the

//	RegIni = new TRegistryIniFile("Software\\BlueCrane Software\\LPMS 3");
	RegIni = new TRegistryIniFile(KeepRegString);

   RegIni->WriteString("Preferences","Key",UserKey);
   RegIni->WriteString("Preferences","DBPrefix",DBPrefix);

   delete RegIni;

   MessageBox(NULL,"Prefix and Key sucessfully updated...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));

   btnProcessM->Default = false;
   btnCancelM->Caption  = "Close";
   btnCancelM->Default  = true;
   btnCancelM->SetFocus();
}

//---------------------------------------------------------------------------
// The Prefix changed on the Maintenance Page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtPrefixMChange(TObject *Sender)
{
   if ((edtPrefixM->Text != "") && (edtKeyM->Text != ""))
      btnProcessM->Enabled = true;
   else
      btnProcessM->Enabled = false;
}

//---------------------------------------------------------------------------
// Key value changed - assist user with auto adding of dashes
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtKeyMChange(TObject *Sender)
{
   int        Count;
   AnsiString ThisKey;

//--- If the backspace key was pressed then we don't do any processing here

   if (edtKeyM->Focused() == true)
   {
      if (BackSpace == true)
      {
         BackSpace = false;
         return;
      }

      Count   = edtKeyM->Text.Length();
      ThisKey = edtKeyM->Text;

      switch (Count)
      {
         case  4:
         case  8:
         case 13:
         case 18:
         case 23:
         case 28:
         case 33:
            ThisKey += "-";
            break;

         case  6:
         case 10:
         case 15:
         case 20:
         case 25:
         case 30:
            if (edtKeyM->Text.SubString(Count,1) == "-")
               ThisKey = edtKeyM->Text.SubString(1, Count - 1);
            break;
      }

      edtKeyM->Text = ThisKey;
      edtKeyM->SelStart = edtKeyM->Text.Length();
   }

   if ((edtPrefixM->Text != "") && (edtKeyM->Text != ""))
      btnProcessM->Enabled = true;
   else
      btnProcessM->Enabled = false;
}

//===========================================================================
//===
//=== Convert Page functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User clicked on the Lock button on the Convert page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnLockCClick(TObject *Sender)
{
   UnicodeString Password;

   if (LockC_State == true)
   {
//      InputQuery("Legal Practise Management System","Pass phrase:",Password);
      Password = InputQueryM("Legal Practise Management System","Pass phrase:",TYPE_PASSWORD);

      if (Password == ThisPass)
         LockC_State = false;
   }
   else
   {
      LockC_State = true;
      edtHostName->Clear();
      edtUserName->Clear();
      edtPassword->Clear();
      edtCurrVersion->Clear();
      stProgress->Caption = "";
      StaticText3->Caption = "LPMS First Run Utility: Enter the information below then click on the [Get] button to retrieve the current Data Base version";
   }

   pgTabsChange(Sender);
}

//---------------------------------------------------------------------------
// User clicked on the Process button on the Convert page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnProcessCClick(TObject *Sender)
{
   int          idx1, Len;
   AnsiString   S1, S2, CurrDate;
   TStringList *ThisList;

//--- Open a connection to the datastore named in HostName

   CSMySQL  = "Provider=MSDASQL.1;Persist Security Info=False;Data Source=BSD_MySQL;User ID=" + edtUserNameC->Text + ";Password=" + edtPasswordC->Text + ";Server=";
   HostName = edtHostNameC->Text;
   Prefix   = edtPrefixC->Text;

   if ((DM_Open_Connection()) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Select the Database to use

   S1 = "USE " + Prefix + "_LPMS";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Check if MultiCompany Support is selected and if so whether a DBPrefix was
//--- specified

   if (cbMultiCpy->Checked == true)
   {
      if (edtNewPrefixC->Text.IsEmpty() == true)
      {
         MessageBox(NULL,"'New Prefix:' must be specified if 'Multi Company Support' is selected.","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         edtNewPrefixC->SetFocus();
         return;
      }
   }

//--- Convert from 2.2.1 to 3.0.1

   if (edtCurrVersion->Text == "2.2.1")
   {

//--- Update the 'control' table

      stProgress->Caption = "Converting 'control' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE control ADD COLUMN Control_";

      S2 = S1 + "DoBilling Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "UpBilling Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Switch1 Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Switch2 Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Switch3 Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Switch4 Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Switch5 Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = "UPDATE control SET Control_UpBilling = 1 WHERE Control_UserType = 'Administrator'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = "UPDATE control SET Control_DoBilling = 1 WHERE Control_FeeEarner = 1";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "DELETE FROM control WHERE Control_UserID = 'Backup Administrator'";
      S2 = "INSERT INTO control (Control_UserID, Control_Password, Control_Name, Control_Email, Control_UserType, Control_FeeEarner, Control_DoBilling, Control_UpBilling, Control_Switch1, Control_Switch2, Control_Switch3, Control_Switch4, Control_Switch5, Control_Unique, Create_By, Create_Date, Create_Time) Values('Backup Administrator', '«ßÞÉµÓ‘Ÿ', 'Default Backup Administrator', 'lpms@bluecrane.cc', 'Administrator', 0, 0, 0, 1, 0, 0, 0, 0, 0, 'LPMS_FirstRun', '" +
           FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
           FormatDateTime("HH:mm:ss",Now()) + "')";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'tracking' table to enable Collections

      stProgress->Caption = "Converting 'tracking' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE tracking ADD COLUMN Tracking_";

      S2 = S1 + "IntDate VarChar (32)";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Capital Double DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Int Double DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Comm Double DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Contingency Double DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Fees Double DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Prescribed Integer (11) DEFAULT 1";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      CurrDate = FormatDateTime("yyyy/MM/dd",Now());
      S2 = "UPDATE tracking SET Tracking_IntDate = '" + CurrDate +
           "', Tracking_Comm = 10.00, Tracking_Int = 15.50, Tracking_Contingency = 25.00, Tracking_Prescribed = 1";

      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = "UPDATE tracking SET Tracking_FileType = 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'notes' table

      stProgress->Caption = "Converting 'notes' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE notes ADD COLUMN Notes_User VarChar (255) DEFAULT 'System'";
      S2 = "UPDATE notes SET Notes_User = 'System'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'customers' table

      stProgress->Caption = "Converting 'customers' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE customers ADD COLUMN Cust_FreeText VarChar (1024)";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'doccntl' table

      stProgress->Caption = "Converting 'doccntl' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE doccntl ADD COLUMN DocCntl_Facility VarChar(512)";
      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE doccntl ADD COLUMN DocCntl_Container VarChar(255)";
      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE doccntl ADD COLUMN DocCntl_Box VarChar(255)";
      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE doccntl ADD COLUMN DocCntl_Status Integer(11)";
      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = "UPDATE doccntl SET DocCntl_Status = 0 WHERE (DocCntl_DateIn = 'Checked Out' OR DocCntl_DateIn = 'Unset')";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = "UPDATE doccntl SET DocCntl_Status = 1 WHERE (DocCntl_DateOut <> 'Service' AND DocCntl_DateIn <> 'Checked Out' AND DocCntl_DateIn <> 'Unset')";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = "UPDATE doccntl SET DocCntl_Status = 2 WHERE DocCntl_DateOut = 'Service'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Insert the 'collect' table

      stProgress->Caption = "Creating 'collect' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE collect (Collect_Key int(11) NOT NULL AUTO_INCREMENT, Collect_Type int(11) DEFAULT NULL, Collect_Class int(11) DEFAULT NULL, Collect_Date varchar(32) DEFAULT NULL, Collect_Item varchar(128) DEFAULT NULL, Collect_AccountType int(11) DEFAULT NULL, Collect_Description varchar(1024) DEFAULT NULL, Collect_UnitType int(11) DEFAULT NULL, Collect_Units double DEFAULT NULL, Collect_Calculation int(11) DEFAULT NULL, Collect_Label int(11) DEFAULT NULL, Collect_Inc1 int(11) DEFAULT NULL, Collect_Inc2 int(11) DEFAULT NULL, Collect_Minimum double DEFAULT NULL, Collect_Maximum double DEFAULT NULL, Collect_Fixed double DEFAULT NULL, Collect_Rate double DEFAULT NULL, Collect_DrCr int(11) DEFAULT NULL, Collect_Amount double DEFAULT NULL, Collect_Owner varchar(10) DEFAULT NULL, Collect_Related varchar(10) DEFAULT NULL, Collect_FeeEarner int(11) DEFAULT NULL, Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', Collect_TimeStamp varchar(128) DEFAULT NULL, PRIMARY KEY (Collect_Key)) ENGINE=MyISAM ROW_FORMAT=dynamic DEFAULT CHARACTER SET latin1 COLLATE latin1_swedish_ci";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Insert the 'invoices' table

      stProgress->Caption = "Creating 'invoices' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE invoices (Inv_Key int(11) NOT NULL AUTO_INCREMENT, Inv_Invoice varchar(32) DEFAULT NULL, Inv_File varchar(10) DEFAULT NULL, Inv_Amount varchar(32) DEFAULT '0.00', Inv_Description varchar(255) DEFAULT NULL, Inv_HostName varchar(512) DEFAULT NULL, Inv_SDate varchar(10) DEFAULT NULL, Inv_EDate varchar(10) DEFAULT NULL, Inv_AcctType int(11) DEFAULT NULL, Inv_ShowRelated int(11) DEFAULT NULL, Inv_Fees VarChar(32) DEFAULT '0.00', Inv_Disburse VarChar(32) DEFAULT '0.00', Inv_Expenses VarChar(32) DEFAULT '0.00', Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', Inv_TimeStamp varchar(128) DEFAULT NULL, PRIMARY KEY (Inv_Key)) ENGINE=MyISAM ROW_FORMAT=dynamic DEFAULT CHARACTER SET latin1 COLLATE latin1_swedish_ci;";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'lpms' table

      stProgress->Caption = "Converting 'lpms' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE lpms ADD COLUMN ";

      S2 = S1 + "InvoiceIdx Double DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "InvoicePref VarChar(8) DEFAULT 'Inv'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Blocked Integer(11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Reason VarChar(1024)";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'billing' table to change 'Trust Transfer (Fees)' to 'Trust Transfer (Business)'

      stProgress->Caption = "Updating 'billing' Table";
      stProgress->Refresh();

      S1 = "UPDATE billing SET B_Item = 'Trust Transfer (Business)' WHERE B_Item = 'Trust Transfer (Fees)'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'billingitems' table to change 'Trust Transfer (Fees)' to 'Trust Transfer (Business)'

      stProgress->Caption = "Updating 'billingitems' Table";
      stProgress->Refresh();

      S1 = "UPDATE billingitems SET Bi_Item = 'Trust Transfer (Business)' WHERE Bi_Item = 'Trust Transfer (Fees)'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Insert the 'payments' table

      stProgress->Caption = "Creating 'payments' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE payments (Pay_Key int(11) NOT NULL AUTO_INCREMENT, Pay_Invoice varchar(32) DEFAULT NULL, Pay_Date varchar(10) DEFAULT 'Not Paid', Pay_Amount varchar(32) DEFAULT '0.00', Pay_File varchar(10) DEFAULT NULL, Pay_Note varchar(1024) DEFAULT NULL, Pay_Billing varchar(128) DEFAULT 'No Billing', Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', Pay_TimeStamp varchar(128) DEFAULT NULL, PRIMARY KEY (Pay_Key)) ENGINE=MyISAM ROW_FORMAT=dynamic DEFAULT CHARACTER SET latin1 COLLATE latin1_swedish_ci";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the database version

      stProgress->Caption = "Updating database version";
      stProgress->Refresh();

      S2 = "UPDATE lpms SET Version = '3.0.1'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      Query1->Close();
      MySQLCon->Close();

      MessageBox(NULL,AnsiString("Database '" + edtHostNameC->Text + "[" + edtPrefixC->Text + "]' updated from version '" + edtCurrVersion->Text + "' to version '" + edtNewVersion->Text + "'").c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));

      stProgress->Caption = "";
      stProgress->Refresh();
   }

//--- Convert from any version less than 3.2.0

   if (edtCurrVersion->Text < "3.2.0")
   {

//--- Update the 'invoices' table

      stProgress->Caption = "Converting 'invoices' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE invoices ADD COLUMN Inv_";

      S2 = S1 + "Fees VarChar(32) DEFAULT '0.00'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Disburse VarChar(32) DEFAULT '0.00'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "Expenses VarChar(32) DEFAULT '0.00'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Insert the 'payments' table

      stProgress->Caption = "Creating 'payments' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE payments (Pay_Key int(11) NOT NULL AUTO_INCREMENT, Pay_Invoice varchar(32) DEFAULT NULL, Pay_Date varchar(10) DEFAULT 'Not Paid', Pay_Amount varchar(32) DEFAULT '0.00', Pay_File varchar(10) DEFAULT NULL, Pay_Note varchar(1024) DEFAULT NULL, Pay_Billing varchar(128) DEFAULT 'No Billing', Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', Pay_TimeStamp varchar(128) DEFAULT NULL, PRIMARY KEY (Pay_Key)) ENGINE=MyISAM ROW_FORMAT=dynamic DEFAULT CHARACTER SET latin1 COLLATE latin1_swedish_ci";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'payments' table to add Pay_Billing

      stProgress->Caption = "Updating 'payments' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE payments ADD COLUMN Pay_";

      S2 = S1 + "Billing VarChar(128) DEFAULT 'No Billing'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'billing' table to change 'Trust Transfer (Fees)' to 'Trust Transfer (Business)'

      stProgress->Caption = "Updating 'billing' Table";
      stProgress->Refresh();

      S1 = "UPDATE billing SET B_Item = 'Trust Transfer (Business)' WHERE B_Item = 'Trust Transfer (Fees)'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'billing' table to add the Expense column

      S1 = "ALTER TABLE billing ADD COLUMN B_Expense Double DEFAULT 0";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'billing' table to add 'Reserved Deposit' functionality

      S1 = "ALTER TABLE billing ADD COLUMN B_";

      S2 = S1 + "ReserveDep Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "ReserveAmt Double DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "ReserveReason VarChar(1024) DEFAULT 'No Reserved Deposit'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'collect' table to add the Expense column

      stProgress->Caption = "Updating 'collect' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE collect ADD COLUMN Collect_Expense Double DEFAULT 0";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'collect' table to add 'Reserved Deposit' functionality

      S1 = "ALTER TABLE collect ADD COLUMN Collect_";

      S2 = S1 + "ReserveDep Integer (11) DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "ReserveAmt Double DEFAULT 0";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = S1 + "ReserveReason VarChar(1024) DEFAULT 'No Reserved Deposit'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'billingitems' table to change 'Trust Transfer (Fees)' to 'Trust Transfer (Business)'

      stProgress->Caption = "Updating 'billingitems' Table";
      stProgress->Refresh();

      S1 = "UPDATE billingitems SET Bi_Item = 'Trust Transfer (Business)' WHERE Bi_Item = 'Trust Transfer (Fees)'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'billingitems' table to add the Expense column

      S1 = "ALTER TABLE billingitems ADD COLUMN Bi_Expense Double DEFAULT 0";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'tracking' table to add the Prescribed interest column

      stProgress->Caption = "Updating 'tracking' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE tracking ADD COLUMN Tracking_";

      S2 = S1 + "Prescribed Integer (11) DEFAULT 1";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S2 = "UPDATE tracking SET Tracking_Prescribed = 1";

      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'customers' table to add the FreeText column if it does not exist

      stProgress->Caption = "Updating 'customers' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE customers ADD COLUMN Cust_FreeText VarChar (1024) DEFAULT NULL";
      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

/*
//--- Convert Passwords to New Style Passwords if the flag was checked

      DoNewStylePass();

//--- Convert to Multi Company support if cbMuliCpy is checked

      DoMultiCompany();

//--- Update the database version

      stProgress->Caption = "Updating database version";
      stProgress->Refresh();

      S2 = "UPDATE lpms SET Version = '3.1.0'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      MessageBox(NULL,AnsiString("Database '" + edtHostNameC->Text + "[" + edtPrefixC->Text + "]' updated from version '" + edtCurrVersion->Text + "' to version '" + edtNewVersion->Text + "'").c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));

      stProgress->Caption = "";
      stProgress->Refresh();
   }

//--- Add additional items that were added since 3.1.0 originally went live

   if (edtCurrVersion->Text == "3.1.0")
   {

//--- Convert Passwords to New Style Passwords if the flag was checked

      DoNewStylePass();

//--- Convert to Multi Company support if cbMuliCpy is checked

      DoMultiCompany();
*/

//--- Add the Instant Message table

      stProgress->Caption = "Creating 'im' Table";
      stProgress->Refresh();

//--- Insert the 'im' table

      S1 = "CREATE TABLE im (Im_Key int(11) NOT NULL AUTO_INCREMENT, Im_Date varchar(10) DEFAULT NULL, Im_Time varchar(12) DEFAULT NULL, Im_From varchar(64) DEFAULT NULL, Im_To varchar(64) DEFAULT NULL, Im_Message varchar(512) DEFAULT NULL, Im_Status int(11) DEFAULT NULL, PRIMARY KEY (Im_Key)) ENGINE=MyISAM ROW_FORMAT=dynamic DEFAULT CHARACTER SET latin1 COLLATE latin1_swedish_ci";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Add a default message for each user

      ThisList = new TStringList;

      S1 = "SELECT Control_UserID FROM control ORDER BY Control_UserID";
      if (DM_Put_DB(S1,TYPE_SELECT) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      Query1->First();
      for (idx1=0;idx1 < Query1->RecordCount;idx1++)
      {
         ThisList->Add(Query1->FieldByName("Control_UserID")->AsString);
         Query1->Next();
      }

      for (idx1=0;idx1 < ThisList->Count;idx1++)
      {
         S2 = "Hi " + ThisList->Strings[idx1] + ", Welcome to LPMS Internal Messaging. To send a message is easy - Select a User from the list on the Left, type your message and then click on 'Send'";

         S1 = "INSERT INTO im (Im_Date, Im_Time, Im_From, Im_To, Im_Message, Im_Status) Values('" +
              FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
              FormatDateTime("HH:mm:ss.zzz",Now()) + "', 'LPMS_Utility', '" +
              ThisList->Strings[idx1] + "', '" + ReplaceQuote(S2,TYPE_WRITE) +
              "', " + IM_UNREAD + ")";

         if (DM_Put_DB(S1,TYPE_OTHER) == false)
         {
            if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
               return;
         }

         S2 = "You can change the interval for automatically checking new messages and the colours in which messages are dislayed by clicking on the 'IM Prefs' button in the 'Functions' section on the 'Preferences' Screen. Unread messages are displayed in Bold";

         S1 = "INSERT INTO im (Im_Date, Im_Time, Im_From, Im_To, Im_Message, Im_Status ) Values('" +
              FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
              FormatDateTime("HH:mm:ss.zzz",Now()) + "', 'LPMS_Utility', '" +
              ThisList->Strings[idx1] + "', '" + ReplaceQuote(S2,TYPE_WRITE) +
              "', " + IM_UNREAD + ")";

         if (DM_Put_DB(S1,TYPE_OTHER) == false)
         {
            if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
               return;
         }
      }

      delete ThisList;

//--- Insert the 'tbinterest' table

      stProgress->Caption = "Creating 'tbinterest' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE tbinterest (TbInt_Key int(11) NOT NULL AUTO_INCREMENT, TbInt_SetName varchar(1024) DEFAULT 'Not Defined', TbInt_EffectiveDate varchar(10) DEFAULT NULL, TbInt_Rate double DEFAULT NULL, Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', PRIMARY KEY (TbInt_Key)) ENGINE=MyISAM DEFAULT CHARSET=latin1";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Insert default interest rates sets

      S1 = "INSERT INTO tbinterest (TbInt_SetName, TbInt_EffectiveDate, TbInt_Rate, Create_Date, Create_Time, Create_By) Values('Before 01 August 2014', '1980/01/01', 15.00, '" +
           FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
           FormatDateTime("HH:mm:ss.zzz",Now()) + "', 'LPMS_Utility')";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "INSERT INTO tbinterest (TbInt_SetName, TbInt_EffectiveDate, TbInt_Rate, Create_Date, Create_Time, Create_By) Values('Efective 01 August 2014', '2014/08/01', 9.00, '" +
           FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
           FormatDateTime("HH:mm:ss.zzz",Now()) + "', 'LPMS_Utility')";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "INSERT INTO tbinterest (TbInt_SetName, TbInt_EffectiveDate, TbInt_Rate, Create_Date, Create_Time, Create_By) Values('Effective 01 March 2016', '2016/03/01', 10.25, '" +
           FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
           FormatDateTime("HH:mm:ss.zzz",Now()) + "', 'LPMS_Utility')";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Insert the 'tbbilling' table

      stProgress->Caption = "Creating 'tbbilling' Table";
      stProgress->Refresh();

      FilesDir = ExtractFilePath(Application->ExeName);
      FilesDir = AnsiReplaceStr(FilesDir,"\\Bin\\","\\Files\\");
      FilesDir = AnsiReplaceStr(FilesDir,"\\Release\\","\\Files\\");
      FilesDir = AnsiReplaceStr(FilesDir,"\\Debug\\","\\Files\\");

      S1 = "CREATE TABLE tbbilling (TbBilling_Key int(11) NOT NULL AUTO_INCREMENT, TbBilling_SetName varchar(1024) DEFAULT NULL, TbBilling_EffectiveDate varchar(10) DEFAULT NULL, TbBilling_Definition varchar(1024) DEFAULT NULL, Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', PRIMARY KEY (TbBilling_Key)) ENGINE=MyISAM DEFAULT CHARSET=latin1";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Insert default billing definition sets

      S1 = "INSERT INTO tbbilling (TbBilling_SetName, TbBilling_EffectiveDate, TbBilling_Definition, Create_Date, Create_Time, Create_By) Values('Before 01 August 2014', '1980/01/01', '" + ReplaceQuote(FilesDir,TYPE_WRITE) + "Before 01 August 2014.lbd', '" +
           FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
           FormatDateTime("HH:mm:ss.zzz",Now()) + "', 'LPMS_Utility')";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "INSERT INTO tbbilling (TbBilling_SetName, TbBilling_EffectiveDate, TbBilling_Definition, Create_Date, Create_Time, Create_By) Values('Efective 01 August 2014', '2014/08/01', '" + ReplaceQuote(FilesDir,TYPE_WRITE) + "Effective 01 August 2014', '" +
           FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
           FormatDateTime("HH:mm:ss.zzz",Now()) + "', 'LPMS_Utility')";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "INSERT INTO tbbilling (TbBilling_SetName, TbBilling_EffectiveDate, TbBilling_Definition, Create_Date, Create_Time, Create_By) Values('Effective 01 March 2016', '2016/03/01', '" + ReplaceQuote(FilesDir,TYPE_WRITE) + "Effective 01 March 2016', '" +
           FormatDateTime("YYYY/MM/DD",Now()) + "', '"  +
           FormatDateTime("HH:mm:ss.zzz",Now()) + "', 'LPMS_Utility')";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Insert the 'symvars' table

      stProgress->Caption = "Creating 'symvars' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE symvars (Sym_Key int(11) unsigned zerofill NOT NULL AUTO_INCREMENT, Sym_Owner varchar(64) NOT NULL, Sym_Variable varchar(128) NOT NULL, Sym_Value varchar(512) NOT NULL, Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', PRIMARY KEY (Sym_Key)) ENGINE=MyISAM AUTO_INCREMENT=0 DEFAULT CHARSET=latin1";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Add 'Blocked' field to Users table

      stProgress->Caption = "Updating 'control' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE control ADD COLUMN Control_Blocked Integer (11) DEFAULT 0";
      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the database version

      stProgress->Caption = "Updating database version";
      stProgress->Refresh();

      S2 = "UPDATE lpms SET Version = '3.2.0'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      MessageBox(NULL,AnsiString("Database '" + edtHostNameC->Text + "[" + edtPrefixC->Text + "]' updated from version '" + edtCurrVersion->Text + "' to version 3.2.0'").c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));

      stProgress->Caption = "";
      stProgress->Refresh();
   }

//--- Convert to version 3.2.1

   if (edtCurrVersion->Text < "3.2.1")
   {

//===
//=== Todo Change the way the File Path is stored (Store only the File name)
//===

//--- Update the 'users' table to add Logging

      stProgress->Caption = "Converting 'control' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE control ADD COLUMN Control_Logging Integer (11) DEFAULT 3";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE control ADD COLUMN Control_Rate double DEFAULT '0.00'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'users' table to add 'Do Quote' for every user

      S1 = "UPDATE control SET Control_Switch4 = 1";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'invoices' table

      stProgress->Caption = "Converting 'invoices' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE invoices ADD COLUMN Inv_Related varchar (10)";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Select the unique File names in the Invoices table and add to a list

      S1 = "SELECT DISTINCT Inv_File FROM invoices ORDER BY Inv_File";
      if (DM_Put_DB(S1,TYPE_SELECT) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      ThisList = new TStringList;
      Query1->First();

      for (idx1=0;idx1 < Query1->RecordCount;idx1++)
      {
         ThisList->Add(Query1->FieldByName("Inv_File")->AsString);
         Query1->Next();
      }

//--- Get the related file information for each unique File in the Invoice table
//--- and add this to the list - each entry consist of xxxxxxyyyyyy where xxxxxx
//--- is the File name and yyyyyy is the Related file

      for (idx1 = 0; idx1 < ThisList->Count; idx1++)
      {
         S1 = "SELECT Tracking_Related FROM tracking WHERE Tracking_Name = '" + ThisList->Strings[idx1] + "'";

         if (DM_Put_DB(S1,TYPE_SELECT) == false)
         {
            if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
               return;
         }

         ThisList->Strings[idx1] = ThisList->Strings[idx1] + Query1->FieldByName("Tracking_Related")->AsString;
      }

//--- Update the invoices table with the related file names

      if (ThisList->Count <= 1)
         Len = 1;
      else
         Len = ThisList->Strings[0].Length() / 2;

      for (idx1 = 0; idx1 < ThisList->Count; idx1++)
      {
         S1 = "UPDATE invoices SET Inv_Related = '" +
              ThisList->Strings[idx1].SubString(Len + 1, 99) +
              "' WHERE Inv_File = '" + ThisList->Strings[idx1].SubString(1,Len) +
              "'";

         if (DM_Put_DB(S1,TYPE_OTHER) == false)
         {
            if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
               return;
         }
      }

      delete ThisList;

//--- Add the Log table

      stProgress->Caption = "Creating 'log' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE log (Log_Key int(11) NOT NULL AUTO_INCREMENT, Log_Date varchar(20) NOT NULL, Log_Time varchar(20) NOT NULL, Log_User  varchar(255) NOT NULL, Log_Activity varchar(4096) NOT NULL, Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, TimeStamp varchar(128) NOT NULL, PRIMARY KEY (Log_Key)) ENGINE=MyISAM AUTO_INCREMENT=0 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Add the Quotes table

      stProgress->Caption = "Creating 'quotes' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE quotes (Q_Key int(11) NOT NULL AUTO_INCREMENT, Q_Quote varchar(32) DEFAULT NULL, Q_Type int(11) DEFAULT NULL, Q_Class int(11) DEFAULT NULL, Q_Date varchar(32) DEFAULT NULL, Q_Item varchar(128) DEFAULT NULL, Q_AccountType int(11) DEFAULT NULL, Q_Description varchar(1024) DEFAULT NULL, Q_UnitType int(11) DEFAULT NULL, Q_Units double DEFAULT NULL, Q_Calculation int(11) DEFAULT NULL, Q_Label int(11) DEFAULT NULL, Q_Inc1 int(11) DEFAULT NULL, Q_Inc2 int(11) DEFAULT NULL, Q_Minimum double DEFAULT NULL, Q_Maximum double DEFAULT NULL, Q_Fixed double DEFAULT NULL, Q_Rate double DEFAULT NULL, Q_Expense double DEFAULT '0', Q_DrCr int(11) DEFAULT NULL, Q_Amount double DEFAULT NULL, Q_Owner varchar(10) DEFAULT NULL, Q_Related varchar(10) DEFAULT NULL, Q_FeeEarner int(11) DEFAULT NULL, Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', Q_TimeStamp varchar(128) DEFAULT NULL, PRIMARY KEY (Q_Key)) ENGINE=MyISAM AUTO_INCREMENT=0 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Add the Accept table

      stProgress->Caption = "Creating 'accept' Table";
      stProgress->Refresh();

      S1 = "CREATE TABLE accept (Accept_Key int(11) NOT NULL AUTO_INCREMENT, Accept_File varchar(32) DEFAULT NULL, Accept_Quote varchar(32) DEFAULT NULL, Accept_Accepted int(11) DEFAULT NULL, Accept_Date varchar(32) DEFAULT NULL, Accept_HostName varchar(255) DEFAULT NULL, Accept_Description varchar(255) DEFAULT NULL, Create_Date varchar(32) DEFAULT NULL, Create_Time varchar(32) DEFAULT NULL, Create_By varchar(64) DEFAULT NULL, Modify_Date varchar(32) DEFAULT 'Not Modified', Modify_Time varchar(32) DEFAULT 'Not Modified', Modify_By varchar(64) DEFAULT 'Not Modified', Accept_TimeStamp varchar(128) DEFAULT NULL, PRIMARY KEY (Accept_Key)) ENGINE=MyISAM AUTO_INCREMENT=0 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the notes table then distinguish between billing related and file
//--- notes

      stProgress->Caption = "Converting 'notes' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE notes ADD COLUMN Notes_Type int(11) NOT NULL";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- First we set all Notes Types to Fle Notes

      S1 = "UPDATE notes SET Notes_Type = 1";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Then we try and identify Billing Notes and set Notes Type for these
//--- records to Billing Notes

      S1 = "UPDATE notes SET Notes_Type = 2 WHERE ((Notes_Note LIKE 'Inserted new payment record on %') OR (Notes_Note LIKE 'Inserted new billing record on %') OR (Notes_Note LIKE 'Updated existing payment record on %') OR (Notes_Note LIKE 'Updated existing billing record on %') OR (Notes_Note LIKE 'Deleted existing billing record on %') OR (Notes_Note LIKE 'Deleted existing payment record on %'))";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Split 'Trust Transfer (Business)' to distinguish between 'Fees/Disb/Exp'
//--- and 'Other' transfers

      stProgress->Caption = "Updating 'billingitems' Table";
      stProgress->Refresh();

      S1 = "UPDATE billingitems SET Bi_Item = 'Trust Transfer (Business - Fees/Disb/Exp)' WHERE Bi_Item = 'Trust Transfer (Business)'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- First check whether the 'Trust Transfer (Business - Other)' class already
//--- exist to avoid duplicates

      S1 = "SELECT Bi_Key FROM billingitems WHERE Bi_Item = 'Trust Transfer (Business - Other)'";

      if (DM_Put_DB(S1,TYPE_SELECT) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      if (Query1->RecordCount == 0)
      {
         S1 = "INSERT INTO billingitems (Bi_Type, Bi_Class, Bi_User, Bi_Item, Bi_Description, Bi_UnitType, Bi_Units, Bi_Calculation, Bi_Label, Bi_Inc1, Bi_Inc2, Bi_Minimum, Bi_Maximum, Bi_Fixed, Bi_Rate, Bi_DrCr, Create_Date, Create_Time, Create_By, Bi_TimeStamp, Bi_Expense) Values(3, 24, '', 'Trust Transfer (Business - Other)', 'Transfer from Trust to Business for [Other][ on instruction of Client]', 6, '1', 8, 0, 0, 0, '0', '0', '0', '0', 1, '" +
              FormatDateTime("yyyy/MM/dd",Now()) + "', '"  +
              FormatDateTime("HH:mm:ss",Now()) + "', 'LPMS_Utility', '" +
              FormatDateTime("yyyy/MM/ddHH:mm:ss:zzz",Now()) + "+LPMS_Utility" +
              "', '0')";

         if (DM_Put_DB(S1,TYPE_OTHER) == false)
         {
            if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
               return;
         }
      }

      S1 = "UPDATE billing SET B_Item = 'Trust Transfer (Business - Fees/Disb/Exp)' WHERE B_Item = 'Trust Transfer (Business)'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'billing' table

      stProgress->Caption = "Converting 'billing' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE billing ADD COLUMN B_ToFile varchar (32)";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE billing ADD COLUMN B_Unique varchar (128)";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE billing ADD COLUMN B_InvestAcct varchar (32)";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "UPDATE billing SET B_ReserveReason = '' WHERE ((B_Class <> 7) AND (B_Class <> 11))";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'collect' table

      stProgress->Caption = "Converting 'collect' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE collect ADD COLUMN Collect_ToFile varchar (32)";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE collect ADD COLUMN Collect_Unique varchar (128)";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'prefix' table to add File Type and Folder Colour

      stProgress->Caption = "Converting 'prefix' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE prefix ADD COLUMN Prefix_FileType varchar (32) DEFAULT 'Other'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE prefix ADD COLUMN Prefix_FolderCol int (11) DEFAULT 0";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the 'lpms' table

      stProgress->Caption = "Converting 'lpms' Table";
      stProgress->Refresh();

      S1 = "ALTER TABLE lpms ADD COLUMN QuoteIdx double DEFAULT '0'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      S1 = "ALTER TABLE lpms ADD COLUMN QuotePref varchar (8) DEFAULT 'Q'";

      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Correct the spelling of 'practise' in lpms

      S1 = "UPDATE lpms SET Signature = 'Legal Practice Management System - LPMS'";
      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Update the database version

      stProgress->Caption = "Updating database version";
      stProgress->Refresh();

      S2 = "UPDATE lpms SET Version = '3.2.1'";
      if (DM_Put_DB(S2,TYPE_OTHER) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      MessageBox(NULL,AnsiString("Database '" + edtHostNameC->Text + "[" + edtPrefixC->Text + "]' updated from version '" + edtCurrVersion->Text + "' to version '" + edtNewVersion->Text + "'").c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));

      stProgress->Caption = "";
      stProgress->Refresh();
   }

//--- Convert Password Encoding to New Encoding if the flag was checked

#ifdef NEW_ENCODING
   DoNewEncoding();
#endif

//--- Convert Passwords to New Style Passwords if the flag was checked

   DoNewStylePass();

//--- Convert to Multi Company support if cbMuliCpy is checked

   DoMultiCompany();

   Query1->Close();
   MySQLCon->Close();

   btnProcessC->Enabled = false;
   edtCurrVersion->Text = edtNewVersion->Text;
}

//---------------------------------------------------------------------------
// Convert to new style encoding
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::DoNewEncoding(void)
{
   struct Pass_Struct
   {
      AnsiString Password;
      int        Key;
   };

   int               idx1;
   AnsiString        S1, OldStr, NewStr, T1, T2;
   TList            *PassList;
   Pass_Struct      *Pass_Rec;
   TRegistryIniFile *RegIni;

//--- Do the new encoding if the option was selected

   if (cbNewEncode->Checked == true)
   {
      stProgress->Caption = "Converting to New Style Encoding";
      stProgress->Refresh();

      S1 = "SELECT Control_Key, Control_Password FROM control";
      if (DM_Put_DB(S1,TYPE_SELECT) == false)
      {
         if (MessageBox(NULL,AnsiString("Unexpected error: '" + ErrMsg + "'\n\nClick 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

//--- Step through each user definition and change the encoding of the password

      PassList = new TList;

      Query1->First();
      for (idx1 = 0; idx1 < Query1->RecordCount; idx1++)
      {
         Pass_Rec = new Pass_Struct;

#ifdef NEW_ENCODING
         Pass_Rec->Password = Vignere(CYPHER_DEC,AnsiString(Query1->FieldByName("Control_Password")->AsString).c_str(),ThisPass.c_str());
#else
         Pass_Rec->Password = jvCipher->DecodeString(ThisPass,Query1->FieldByName("Control_Password")->AsString);
#endif

         Pass_Rec->Key      = Query1->FieldByName("Control_Key")->AsInteger;
         Pass_Rec->Password = Vignere(CYPHER_ENC,Pass_Rec->Password.c_str(),ThisPass.c_str());

         PassList->Add(Pass_Rec);

         Query1->Next();
      }

//--- Write the transformed passwords to the database

      for (idx1 = 0; idx1 < PassList->Count; idx1++)
      {
         Pass_Rec = (Pass_Struct *)PassList->Items[idx1];

         S1 = "UPDATE control SET Control_Password = '" + Pass_Rec->Password + "' WHERE Control_Key = " + IntToStr(Pass_Rec->Key);
         if (DM_Put_DB(S1,TYPE_OTHER) == false)
         {
            if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            {
               PassList->Clear();
               delete PassList;
               return;
            }
         }
      }

//--- Check whether MultiCompany was selected at login and if so then ensure
//--- that the correct hive is read.

      if (MultiCompany == true)
         RegIni = new TRegistryIniFile("Software\\BlueCrane Software\\LPMS 3\\" + ThisDBPrefix);
      else
         RegIni = new TRegistryIniFile("Software\\BlueCrane Software\\LPMS 3");

//--- Transform the value of DBPrefix

      OldStr = jvCipher->DecodeString(ThisPass,RegIni->ReadString("Preferences","DBPrefix","invalid"));
      NewStr = Vignere(CYPHER_ENC,OldStr.c_str(),ThisPass.c_str());
      T1     = NewStr.SubString(1,6);
      T2     = NewStr.SubString(7,99);
      NewStr = T1 + EncodePass(T2);
      RegIni->WriteString("Preferences","DBPrefix",NewStr);

      delete RegIni;

//--- Release the memory that was allocated to the password list

      PassList->Clear();
      delete PassList;
   }
}

//---------------------------------------------------------------------------
// Convert to new style passwords
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::DoNewStylePass(void)
{
   struct Pass_Struct
   {
      AnsiString Password;
      int        Key;
   };

   int               idx1;
   bool              NewStylePass, DoNewStyle;
   AnsiString        S1;
   TList            *PassList;
   Pass_Struct      *Pass_Rec;
   TRegistryIniFile *RegIni;

   if (cbNewPass->Checked == true)
   {
      stProgress->Caption = "Converting to New Style Passwords";
      stProgress->Refresh();

//--- Check whether MultiCompany was selected at login and if so then ensure
//--- that the correct hive is read.

      if (MultiCompany == true)
         RegIni = new TRegistryIniFile("Software\\BlueCrane Software\\LPMS 3\\" + ThisDBPrefix);
      else
         RegIni = new TRegistryIniFile("Software\\BlueCrane Software\\LPMS 3");

//--- Check if the NewStylePassword Key exists and warn user if it does

      NewStylePass = RegIni->ValueExists("Preferences","NewStylePass");
      if (NewStylePass == true)
         NewStylePass = RegIni->ReadBool("Preferences","NewStylePass",false);

      DoNewStyle = true;

      if (NewStylePass == true)
      {
         if (MessageBox(NULL,AnsiString("WARNING: New Style Password registry key already exists. Proceeding with a conversion to New Style Passwords may result in an inability to log into LPMS.\n\nClick 'Yes' to proceed or 'No' to skip").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            DoNewStyle = false;
      }

      if (DoNewStyle == true)
      {
         S1 = "SELECT * FROM control";
         if (DM_Put_DB(S1,TYPE_SELECT) == false)
         {
            if (MessageBox(NULL,AnsiString("Unexpected error: '" + ErrMsg + "'\n\nClick 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
               return;
         }

//--- Extract the Passowrd and Key for each record in the control table then
//--- transform the password to a new style password

         PassList = new TList;

         Query1->First();
         for (idx1 = 0; idx1 < Query1->RecordCount; idx1++)
         {
            Pass_Rec = new Pass_Struct;

            Pass_Rec->Password = Query1->FieldByName("Control_Password")->AsString;
            Pass_Rec->Key      = Query1->FieldByName("Control_Key")->AsInteger;
            Pass_Rec->Password = EncodePass(Pass_Rec->Password);

            PassList->Add(Pass_Rec);

            Query1->Next();
         }

//--- Write the transformed passwords to the database

         for (idx1 = 0; idx1 < PassList->Count; idx1++)
         {
            Pass_Rec = (Pass_Struct *)PassList->Items[idx1];

            S1 = "UPDATE control SET Control_Password = '" + Pass_Rec->Password + "' WHERE Control_Key = " + IntToStr(Pass_Rec->Key);
            if (DM_Put_DB(S1,TYPE_OTHER) == false)
            {
               if (MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg + ", Click 'Yes' to continue or 'No' to abort").c_str(),"Legal Practise Management System - FirstRun",(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
               {
                  PassList->Clear();
                  delete PassList;
                  return;
               }
            }
         }

//--- Release the memory that was allocated to the password list

         PassList->Clear();
         delete PassList;

         RegIni->WriteBool("Preferences","NewStylePass",true);
         delete RegIni;
      }
   }
}

//---------------------------------------------------------------------------
// Set up for Multi Company support
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::DoMultiCompany(void)
{
   int               idx1, ThisIntVal;
   double            ThisFltVal;
   AnsiString        SingleCpyReg, MultiCpyReg, ThisStrVal;
   AnsiString        LocalDBPrefix, T1, T2;
   TRegistryIniFile *RegIniSgl, *RegIniMul;

#include "LPMS_Registry.inc"

   if (cbMultiCpy->Checked == true)
   {
      stProgress->Caption = "Converting to Multi Company";
      stProgress->Refresh();

      SingleCpyReg = "Software\\BlueCrane Software\\LPMS 3";
      MultiCpyReg  = "Software\\BlueCrane Software\\LPMS 3\\" + edtNewPrefixC->Text;

      RegIniSgl = new TRegistryIniFile(SingleCpyReg);
      RegIniMul = new TRegistryIniFile(MultiCpyReg);

//--- Transfer the Character Keys from the Single Location to the Multi location

      for (idx1 = 0; idx1 < IdxChar; idx1++)
      {
         if (RegIniSgl->ValueExists("Preferences",DefChar[idx1]))
         {
            ThisStrVal = RegIniSgl->ReadString("Preferences",DefChar[idx1],"Not Found");
            RegIniMul->WriteString("Preferences",DefChar[idx1],ThisStrVal);
         }
      }

//--- Add the Integer Keys to the list

      for (idx1 = 0; idx1 < IdxInt; idx1++)
      {
         if (RegIniSgl->ValueExists("Preferences",DefInt[idx1]))
         {
            ThisIntVal = RegIniSgl->ReadInteger("Preferences",DefInt[idx1],0);
            RegIniMul->WriteInteger("Preferences",DefInt[idx1],ThisIntVal);
         }
      }

//--- Add the Float Keys to the list

      for (idx1 = 0; idx1 < IdxFloat; idx1++)
      {
         if (RegIniSgl->ValueExists("Preferences",DefFloat[idx1]))
         {
            ThisFltVal = RegIniSgl->ReadFloat("Preferences",DefFloat[idx1],0L);
            RegIniMul->WriteFloat("Preferences",DefFloat[idx1],ThisFltVal);
         }
      }

//--- Insert the Multi Company flag

      RegIniSgl->WriteString("Preferences","MultiCompany","1");

//--- Insert DBPrefix for the new Multi Company

#ifdef NEW_ENCODING
   LocalDBPrefix = Vignere(CYPHER_ENC,AnsiString(edtNewPrefixC->Text + FormatDateTime("yyyy/mm/dd",Now())).c_str(),ThisPass.c_str());
   T1 = LocalDBPrefix.SubString(1,6);
   T2 = LocalDBPrefix.SubString(7,99);
   LocalDBPrefix = T1 + EncodePass(T2);
#else
   LocalDBPrefix = jvCipher->EncodeString(ThisPass,(edtNewPrefixC->Text + FormatDateTime("yyyy/mm/dd",Now())));
#endif

      RegIniMul->WriteString("Preferences","DBPrefix",LocalDBPrefix);

      delete RegIniSgl;
      delete RegIniMul;
   }
}

//---------------------------------------------------------------------------
// A Field on the Convert page changed
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtHostNameCChange(TObject *Sender)
{
   int  FldCount = 0;

//--- Check if the Get button can be enabled

   if (edtHostNameC->Text != "") FldCount++;
   if (edtUserNameC->Text != "") FldCount++;
   if (edtPasswordC->Text != "") FldCount++;

   if (FldCount == 3)
      btnGet->Enabled = true;
   else
      btnGet->Enabled = false;

//--- Check if the Process button can be enabled

   FldCount = 0;

   if (edtHostNameC->Text != "") FldCount++;
   if (edtUserNameC->Text != "") FldCount++;
   if (edtPasswordC->Text != "") FldCount++;
   if (edtCurrVersion->Text != "")  FldCount++;

   if (FldCount == 4)
      btnProcessC->Enabled = true;
   else
      btnProcessC->Enabled = false;
}

//---------------------------------------------------------------------------
// User clicked on the button to get the current database version
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnGetClick(TObject *Sender)
{
   AnsiString S1;

//--- Open a connection to the datastore named in HostName

   CSMySQL  = "Provider=MSDASQL.1;Persist Security Info=False;Data Source=BSD_MySQL;User ID=" + edtUserNameC->Text + ";Password=" + edtPasswordC->Text + ";Server=";
   HostName = edtHostNameC->Text;
   Prefix   = edtPrefixC->Text;

   if ((DM_Open_Connection()) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Select the Database to use

   S1 = "USE " + Prefix + "_LPMS";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Get the current version from the database

   S1 = "SELECT Version FROM lpms";
   if (DM_Put_DB(S1,TYPE_SELECT) == false)
   {
      MessageBox(NULL,AnsiString("Error message: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONWARNING|MB_SYSTEMMODAL));
      return;
   }
   else
   {
      edtCurrVersion->Text = Query1->FieldByName("Version")->AsString;
      Query1->Close();
      MySQLCon->Close();
   }

   edtHostNameCChange(Sender);
   StaticText3->Caption = "LPMS First Run Utility: Click on the [Process] button to convert the Database from version '" + edtCurrVersion->Text + "' to version '" + edtNewVersion->Text + "'";

//--- Process the Multi Company checkbox

   cbMultiCpy->Checked = false;

   if (edtCurrVersion->Text >= "3.0.1")
      cbMultiCpy->Visible = true;
   else
      cbMultiCpy->Visible = false;

//--- Process the New Style Passwords and New Encode checkboxes

   cbNewPass->Checked   = false;
   cbNewEncode->Checked = false;

   if (edtCurrVersion->Text >= "3.0.2")
   {
      cbNewPass->Visible   = true;
      cbNewEncode->Visible = true;
   }
   else
   {
      cbNewPass->Visible   = false;
      cbNewEncode->Visible = false;
   }
}

//---------------------------------------------------------------------------
// Function to do a transformation on a password if NewStylePass is set
//---------------------------------------------------------------------------
AnsiString __fastcall TFLPMS_FirstRunApp::EncodePass(AnsiString ThisPass)
{
   int         idx1;
   char        Hi, Lo;
   char        S1[65];
   AnsiString  S2;

   strcpy(S1,ThisPass.c_str());
   S2   = "";
   idx1 = 0;

   while (S1[idx1] != 0x00)
   {

//--- Get copies of the current character

      Hi = Lo = S1[idx1];

//--- Move the 4 high bits to the right and mask out the four left bits

      Hi = Hi >> 4;
      Hi = Hi & 0x0F;
      Lo = Lo & 0x0F;

//--- Turn the Hi and Lo parts into displayable characters

      Hi = Hi | 0x40;
      Lo = Lo | 0x40;

//--- Add them to the result string

      S2 += Hi;
      S2 += Lo;

      idx1++;
   }
   return(S2);
}

//===========================================================================
//===
//=== Upgrade Page functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User clicked on the Lock button on the Upgrade page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnLockUClick(TObject *Sender)
{
   UnicodeString Password;

   if (LockU_State == true)
   {
//      InputQuery("Legal Practise Management System","Pass phrase:",Password);
      Password = InputQueryM("Legal Practise Management System","Pass phrase:",TYPE_PASSWORD);

      if (Password == ThisPass)
         LockU_State = false;
   }
   else
   {
      LockU_State = true;
      lvAlpha->Clear();
      lvNumeric->Clear();
      lvExclude->Clear();
      rbSilent->Checked  = false;
      rbSave->Checked    = false;
      rbRestore->Checked = false;
      cbPersist->Checked = false;
      cbIgnore->Checked  = false;
      cbDebug->Checked   = false;
      edtFolder->Clear();
      edtRoot->Clear();
      edtSubkey->Clear();
      edtSetupLoc->Clear();
   }

   pgTabsChange(Sender);
}

//---------------------------------------------------------------------------
// User clicked on the Upgrade button on the Upgrade page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnUpgradeUClick(TObject *Sender)
{
   int        idx;
   AnsiString ParmList = "", ThisGUID = "{47A47B9B-8562-4A31-B06E-806D9E26A148}";
   HINSTANCE  ReturnValue;

   if (rbSave->Checked == true)
      ParmList = "-TStart";
   else if (rbRestore->Checked == true)
      ParmList = "-TEnd";
   else
   {
      if (edtSetupLoc->Text.IsEmpty() == true)
      {
         MessageBox(NULL,"'Setup Location' must be specified when 'Silent' is selected","Legal Practise Management System",(MB_OK|MB_ICONSTOP));
         edtSetupLoc->SetFocus();
         return;
      }

      ParmList = "-TFull -G" + ThisGUID + " -M" + AnsiReplaceStr(AnsiReplaceStr(edtSetupLoc->Text,":","~")," ","#");
   }

   for (idx = 0; idx < lvAlpha->Items->Count; idx++)
   {
      if (lvAlpha->Items->Item[idx]->Caption != "")
         ParmList += " -K" + lvAlpha->Items->Item[idx]->Caption;
   }

   for (idx = 0; idx < lvNumeric->Items->Count; idx++)
   {
      if (lvNumeric->Items->Item[idx]->Caption != "")
         ParmList += " -I" + lvNumeric->Items->Item[idx]->Caption;
   }

   for (idx = 0; idx < lvExclude->Items->Count; idx++)
   {
      if (lvExclude->Items->Item[idx]->Caption != "")
         ParmList += " -X" + lvExclude->Items->Item[idx]->Caption;
   }

   if (cbPersist->Checked == true)
      ParmList += " -p";

   if (cbIgnore->Checked == true)
      ParmList += " -z";

   if (cbDebug->Checked == true)
      ParmList += " -d";

   if (edtFolder->Text.IsEmpty() == false)
      ParmList += " -F" + AnsiReplaceStr(AnsiReplaceStr(edtFolder->Text,":","~")," ","#");

   if (edtRoot->Text.IsEmpty() == false)
      ParmList += " -R" + AnsiReplaceStr(AnsiReplaceStr(edtRoot->Text,":","~")," ","#");

   if (edtSubkey->Text.IsEmpty() == false)
      ParmList += " -S" + AnsiReplaceStr(AnsiReplaceStr(edtSubkey->Text,":","~")," ","#");

   ReturnValue = ShellExecute(Sender, "open", LPMSUpgrade.c_str(), ParmList.c_str(), NULL, SW_SHOWNORMAL);

   if ((int)ReturnValue < 33)
   {
      MessageBox(NULL,"Failed to invoke LPMS_Upgrade.exe","Legal Practise Management System",(MB_OK|MB_ICONSTOP));
      return;
   }

//--- If silent mode was requested then LPMS_FirstRun is terminated
//--- automatically since it cannot be active when LPMS is uninstalled

   if (rbSilent->Checked == true)
   {
      Application->Terminate();
      return;
   }
}

//---------------------------------------------------------------------------
// User selected Save Mode
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::rbSaveClick(TObject *Sender)
{
   lvAlpha->Enabled   = true;
   lvNumeric->Enabled = true;
   lvExclude->Enabled = true;
   cbIgnore->Enabled  = true;

   btnUpgradeU->Enabled = true;
   edtFolder->SetFocus();
}

//---------------------------------------------------------------------------
// User selected Restore Mode
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::rbRestoreClick(TObject *Sender)
{
   lvAlpha->Enabled   = false;
   lvNumeric->Enabled = false;
   lvExclude->Enabled = false;
   cbIgnore->Enabled  = false;

   btnUpgradeU->Enabled = true;
   edtFolder->SetFocus();
}

//---------------------------------------------------------------------------
// User clicked on the button to do a Silent (Full) upgrade
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::rbSilentClick(TObject *Sender)
{
   lvAlpha->Enabled   = true;
   lvNumeric->Enabled = true;
   lvExclude->Enabled = true;
   cbIgnore->Enabled  = true;

   btnUpgradeU->Enabled = true;
   edtFolder->SetFocus();
}

//---------------------------------------------------------------------------
// User selected a folder or cancelled the dialog
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtFolderDialogClose(TObject *Sender, UnicodeString &NewDirectory, bool OK)
{
   if (OK == true)
      NewDirectory = IncludeTrailingBackslash(NewDirectory);
}

//---------------------------------------------------------------------------
// User clicked on the button embedded in the Setup Location filed
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtSetupLocClickBtn(TObject *Sender)
{
   edtSetupLoc->Filter      = "Executable Files (*.exe)|*.exe|All Files (*.*)|*.*";
   edtSetupLoc->DefaultExt  = ".exe";
   edtSetupLoc->FilterIndex = 1;
}

//---------------------------------------------------------------------------
// User passed parameters to FirstRun to perform a silent upgrade of LPMS
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::SilentUpgrade(void)
{
   int        idx;
   AnsiString ParmList = "";

   ParmList  = "-TFull -G" + ThisGUID;
   ParmList += " -M" + AnsiReplaceStr(AnsiReplaceStr(ThisInstall,":","~")," ","#");
   ParmList += " -FC~\\";
   ParmList += " -R" + AnsiReplaceStr(AnsiReplaceStr("Software\\BlueCrane Software\\LPMS 3",":","~")," ","#");
   ParmList += " -SPreferences";

   ShellExecute(Application, "open", LPMSUpgrade.c_str(), ParmList.c_str(), NULL, SW_SHOWNORMAL);
}

//===========================================================================
//===
//=== SQL Page functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User clicked on the Lock button on the SQL Page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnLockDClick(TObject *Sender)
{
   UnicodeString Password;

   if (LockD_State == true)
   {
//      InputQuery("Legal Practise Management System","Pass phrase:",Password);
      Password = InputQueryM("Legal Practise Management System","Pass phrase:",TYPE_PASSWORD);

      if (Password == ThisPass)
         LockD_State = false;
   }
   else
   {
      LockD_State = true;

      edtHostNameD->Clear();
      edtUserNameD->Clear();
      edtPasswordD->Clear();
      edtPrefixD->Clear();
      edtSQLD->Clear();
   }

   pgTabsChange(Sender);
}

//---------------------------------------------------------------------------
// User click on the Process button on the SQL Page
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnProcessDClick(TObject *Sender)
{
   AnsiString S1;

//--- Keep track of the commands that are entered

   if (edtSQLD->Items->IndexOf(edtSQLD->Text) == -1)
      edtSQLD->Items->Insert(0,edtSQLD->Text);

//--- Open a connection to the datastore named in HostName

   CSMySQL  = "Provider=MSDASQL.1;Persist Security Info=False;Data Source=BSD_MySQL;User ID=" + edtUserNameD->Text + ";Password=" + edtPasswordD->Text + ";Server=";
   HostName = edtHostNameD->Text;
   Prefix   = edtPrefixD->Text;

   if ((DM_Open_Connection()) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Select the Database to use

   S1 = "USE " + Prefix + "_LPMS";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

   SemaSQL = false;

//--- Execute the SQL Statement

   Query1->Close();
   Query1->SQL->Text = edtSQLD->Text;

   if ((edtSQLD->Text.SubString(1,6).LowerCase() == "select") || (edtSQLD->Text.SubString(1,4).LowerCase() == "show"))
      Query1->Open();
   else
      Query1->ExecSQL();

}

//---------------------------------------------------------------------------
// A field on the SQL Page changed
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtHostNameDChange(TObject *Sender)
{
   int  FldCount = 0;

   if (LockD_State == true)
      return;

//--- Check if the Process button can be enabled

   if (edtHostNameD->Text != "") FldCount++;
   if (edtUserNameD->Text != "") FldCount++;
   if (edtPasswordD->Text != "") FldCount++;
   if (edtPrefixD->Text   != "") FldCount++;
   if (edtSQLD->Text      != "") FldCount++;

   if (FldCount == 5)
      btnProcessD->Enabled = true;
   else
      btnProcessD->Enabled = false;
}

//---------------------------------------------------------------------------
// Executed after data was loaded from the DB - adjust column width
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::Query1AfterOpen(TDataSet *DataSet)
{
/*
   int        idx1, idx2, idx3, Len, Top, ThisLen;
   AnsiString Str;

   ThisLen = DBGrid1->Columns->Count;

   for (idx1 = 0; idx1 < DBGrid1->Columns->Count; idx1++)
   {
      Str = DBGrid1->Columns->Items[idx1]->Title->Caption;
      Top = Str.Length() * 6;

      Query1->First();
      for (idx2 = 0; idx2 < Query1->RecordCount; idx2++)
      {

         Str = Query1->Fields->FieldByNumber(idx1 + 1)->AsAnsiString;
         Len = Str.Length() * 6;

         if (Len > Top)
         {
            Top = Len;
         }

         Query1->Next();
         DBGrid1->Columns->Items[idx1]->Width = Top;
    }

//      DBGrid1->Columns->Items[idx1]->Width = Top;
   }
*/
}

//---------------------------------------------------------------------------
// Function to manage column sizes
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::ColSizes(TObject *Sender)
{
   int TotalColumnWidth, ColumnCount, GridClientWidth, Filler, idx;

   ColumnCount = DBGrid1->Columns->Count;

   if (ColumnCount == 0)
      return;

//--- Compute total width used by grid columns and vertical lines if any

   TotalColumnWidth = 0;

   for (idx = 0; idx < ColumnCount; idx++)
      TotalColumnWidth += DBGrid1->Columns->Items[idx]->Width;

//--- Include vertical lines in total (one per column)

   if (DBGrid1->Options.Contains(dgColLines))
      TotalColumnWidth += ColumnCount;

//--- Compute grid client width by excluding vertical scroll bar, grid
//--- indicator, and grid border

   GridClientWidth = DBGrid1->Width - GetSystemMetrics(SM_CXVSCROLL);

   if (DBGrid1->Options.Contains(dgIndicator))
   {
      GridClientWidth = GridClientWidth - IndicatorWidth;
      if (DBGrid1->Options.Contains(dgColLines))
         GridClientWidth--;
   }

   if (DBGrid1->BorderStyle == bsSingle)
   {
//--- If border is sunken then it is 2 pixels wide otherwise 1 pixel

      if (DBGrid1->Ctl3D == true)
         GridClientWidth -= 4;
      else
         GridClientWidth -= 2;
   }

//--- Adjust Column widths

   if (TotalColumnWidth < GridClientWidth)
   {
      Filler = (GridClientWidth - TotalColumnWidth) / ColumnCount;

      for (idx = 0; idx < ColumnCount; idx++)
         DBGrid1->Columns->Items[idx]->Width += Filler;
   }
   else if (TotalColumnWidth > GridClientWidth)
   {
      Filler = (TotalColumnWidth - GridClientWidth) / ColumnCount;

      if (((TotalColumnWidth - GridClientWidth) % ColumnCount) != 0)
         Filler++;

      for (idx = 0; idx < ColumnCount; idx++)
         DBGrid1->Columns->Items[idx]->Width -= Filler;
   }
}

//===========================================================================
//===
//=== Restore Page functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User clicked on the button embedded in the Backup File field
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtBackupFileClickBtn(TObject *Sender)
{
   edtBackupFile->Filter      = "LPMS Backup Files (*.lpb)|*.lpb|All Files (*.*)|*.*";
   edtBackupFile->DefaultExt  = ".lpb";
   edtBackupFile->FilterIndex = 1;
}

//---------------------------------------------------------------------------
// User selected a backup file to be restored or clicked on Cancel
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtBackupFileDialogExit(TObject *Sender, bool ExitOK)
{
   int         idx1;
   TListItem  *ThisList;

//--- Allow the user to select the backup file

   if (ExitOK == false)
      return;

//--- Allocate memory for the lists that will be used

   ImportList = new TStringList;
   TableList  = new TStringList;

   GetList(edtBackupFile->Text);

//--- Check whether the Backup is a valid backup file

   if (((edtTitle->Text == "LPMS_Backup") && (edtVersion->Text >= "3.0.2")) || (edtTitle->Text == "BSD_Backup_Manager"))
      cbType->Checked = true;
   else
   {
      MessageBox(NULL,AnsiString("'" + edtBackupFile->Text + "' appears not to be a valid backup file.").c_str(),"Legal Practise Management System - Restore from Backup",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      ImportList->Clear();
      TableList->Clear();
      delete ImportList;
      delete TableList;

      return;
   }

   if (edtMode->Text == "Managed")
   {
      stMsgB->Caption  = "LPMS First Run Utility: Select 'Full Restore' to restore all tables listed below or select 'Choose what to Restore' to do a selective restore of the tables listed below. Select 'Replace content' to replace the current content of the selected databases. WARNING: This action will destroy the current content of the database and cannot be reversed once started.";

      rbFull->Enabled     = true;
      rbPartial->Enabled  = true;
      cbType->Enabled     = true;
      edtTitle->Enabled   = true;
      edtDate->Enabled    = true;
      edtTime->Enabled    = true;
      edtVersion->Enabled = true;
      edtMode->Enabled    = true;
      edtType->Enabled    = true;
   }
   else
   {
      stMsgB->Caption    = "LPMS First Run Utility: Click [Restore] to proceed with the Restore or [Cancel] to cancel the Restore request. WARNING: This action will destroy the current content of the tables listed below and cannot be reversed once started.";
   }

//--- Extract the tables that are in scope

   lvTables->Clear();

   for (idx1=0;idx1<TableList->Count;idx1++)
   {
      ThisList = lvTables->Items->Add();

      ThisList->Caption = TableList->Strings[idx1];
      ThisList->Checked = true;
   }

   rbFullClick(Sender);
}

//---------------------------------------------------------------------------
// User clicked on the Process button on the Restore tab
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnProcessBClick(TObject *Sender)
{
   int         idx1, idx2, idx3, RecCount = 0;
   bool        Found = false;
   AnsiString  S0, S1, ThisTable, SaveConStr, SaveHostName;

//--- Check whether any items have been selected

   for (idx1=0;idx1<lvTables->Items->Count;idx1++)
   {
      if (lvTables->Items->Item[idx1]->Checked == true)
      {
         Found = true;
         break;
      }
   }

   if (Found == false)
      return;

//--- Insert the tables to be restored up into the TableList

   TableList = new TStringList;

   for (idx1=0;idx1<lvTables->Items->Count;idx1++)
   {
      if (lvTables->Items->Item[idx1]->Checked == true)
         TableList->Add(lvTables->Items->Item[idx1]->Caption);
   }

//--- Select the MySQL server on which the information will be restored

   DoRestore = false;

   FLPMS_FirstRunApp->Hide();
   FLPMS_FirstRunSelDB = new TFLPMS_FirstRunSelDB(Application);
   FLPMS_FirstRunSelDB->ShowModal();
   delete FLPMS_FirstRunSelDB;
   FLPMS_FirstRunApp->Show();

   if (DoRestore == false)
      return;

//--- If we get here we can proceed with the Restore. Connect to the Database
//--- using the credentials provided by the user.

   SaveConStr   = CSMySQL;
   SaveHostName = HostName;

   CSMySQL  = "Provider=MSDASQL.1;Persist Security Info=False;Data Source=BSD_MySQL;User ID=" + RestoreUser + ";Password=" + RestorePass + ";Server=";
   HostName = RestoreHost;

   if ((DM_Open_Connection()) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

//--- Select the database associated with the DBPRefix

   S1 = "USE " + ThisDBPrefix + "_LPMS";
   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return;
   }

   if (edtMode->Text == "Standalone")
   {
//--- The backup was taken in Standalone mode - we simply execute each SQL
//--- instruction in the ImportList (loaded from the Backup file) in turn
//--- We start with string 1 as string 0 contains the meta data

//--- Give the user another chance to opt out

      if (MessageBox(NULL,AnsiString("WARNING: Backup taken on " + edtDate->Text + " at " + edtTime->Text + " will overwrite existing information in Database '" + RestoreHost + "[" + ThisDBPrefix + "]'.\nWARNING: This is a permanent operation and cannot be reversed once started.\n\nClick 'Yes' to continue with the Restore or 'No' to return.").c_str(),AnsiString("Legal Practise Management System - Restore from Backup").c_str(),(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
         return;

      stProgressB->Caption = "Writing Record no.: 1";
      stProgressB->Refresh();

      for (idx1=1;idx1<ImportList->Count;idx1++)
      {
         S1 = ImportList->Strings[idx1];
         if (DM_Put_DB(S1,TYPE_OTHER) == false)
         {
            stProgressB->Caption = "Writing Record no.: " + IntToStr(RecCount);
            stProgressB->Refresh();
            MessageBox(NULL,AnsiString("Information message: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));
            return;
         }

         if (++RecCount % 10 == 0)
         {
            stProgressB->Caption = "Writing Record no.: " + IntToStr(RecCount);
            stProgressB->Refresh();
         }
      }
   }
   else
   {
//--- The backup was taken in Managed mode - we need to work through the SQL
//--- statements systematically and restore only the tables in the list returned
//--- from FldExpImp. In addition we need to take the value of BackupReplace
//--- into account. If the value is true then we need to DROP and CREATE the
//--- table before restoring.
//--- We start with string 1 as string 0 contains the meta data

//--- Give the user another chance to opt out if 'Replace content' was selected

      if (cbType->Checked == true)
      {
         if (MessageBox(NULL,AnsiString("WARNING: Backup taken on " + edtDate->Text + " at " + edtTime->Text + " will overwrite existing information in Database '" + RestoreHost + "[" + DBPrefix + "]'.\nWARNING: This is a permanent operation and cannot be reversed once started.\n\nClick 'Yes' to continue with the Restore or 'No' to return.").c_str(),AnsiString("Legal Practise Management System - Restore from Backup").c_str(),(MB_YESNO|MB_ICONSTOP|MB_SYSTEMMODAL)) == ID_NO)
            return;
      }

      idx3 = 1;
      for (idx1=0;idx1<TableList->Count;idx1++)
      {
         idx2 = FindTable(TableList->Strings[idx1],idx3);
         if (idx2 == -1)
         {
            MessageBox(NULL,AnsiString("Unexpected error during Restore - Table '" + TableList->Strings[idx1] + "' is not in the Backup file.\n\nRestore process aborted").c_str(),"Legal Practise Management System - Restore from Backup",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            return;
         }

         idx3 = idx2;

         S0 = ImportList->Strings[idx3].SubString(1,1);
         S1 = ImportList->Strings[idx3].SubString(2,999999);
         ThisTable = S1;

         stProgressB->Caption = "Restoring Table '" + ThisTable + "', Writing Record no.: 1";
         stProgressB->Refresh();

         if (cbType->Checked == false)
            idx3 += 3;
         else
            idx3++;

         while (StrToInt(ImportList->Strings[idx3].SubString(1,1)) != LINE_TABLE)
         {
            S1 = ImportList->Strings[idx3].SubString(2,999999);
            if (DM_Put_DB(S1,TYPE_OTHER) == false)
            {
               stProgressB->Caption = "Restoring Table '" + ThisTable + "', Writing Record no.: " + IntToStr(RecCount);
               stProgressB->Refresh();
               MessageBox(NULL,AnsiString("Information message: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));
               return;
            }

            if (++RecCount % 10 == 0)
            {
               stProgressB->Caption = "Restoring Table '" + ThisTable + "', Writing Record no.: " + IntToStr(RecCount);
               stProgressB->Refresh();
            }

            idx3++;
         }
      }
   }

//--- Show the final count

   if (edtMode->Text == "Standalone")
      stProgressB->Caption = "Writing Record no.: " + IntToStr(RecCount);
   else
      stProgressB->Caption = "Restoring Table '" + ThisTable + "', Writing Record no.: " + IntToStr(RecCount);

   stProgressB->Refresh();

//--- Close the database

   Query1->Close();
   MySQLCon->Close();

   CSMySQL  = SaveConStr;
   HostName = SaveHostName;

   MessageBox(NULL,"Restore successfully completed","Legal Practise Management System - Restore from Backup",(MB_OK|MB_ICONINFORMATION|MB_SYSTEMMODAL));
   stProgressB->Caption = "";

}

//---------------------------------------------------------------------------
// Function to locate the start of the passed table in the Restore list
//---------------------------------------------------------------------------
int __fastcall TFLPMS_FirstRunApp::FindTable(AnsiString ThisTable, int idx1)
{
   int idx2;
   AnsiString S0, S1, FoundTable;

   for (idx2=idx1;idx2<ImportList->Count;idx2++)
   {
      S0 = ImportList->Strings[idx2].SubString(1,1);
      S1 = ImportList->Strings[idx2].SubString(2,999999);

      if (StrToInt(S0) == LINE_TABLE)
         FoundTable = S1;

      if (FoundTable == ThisTable)
         return(idx2);
   }
   return(-1);
}

//---------------------------------------------------------------------------
// User clicked on the Lock/Unlock button on the Restore Tab
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnUnlockBClick(TObject *Sender)
{
   UnicodeString Password;

   if (LockB_State == true)
   {
//      InputQuery("Legal Practise Management System","Pass phrase:",Password);
      Password = InputQueryM("Legal Practise Management System","Pass phrase:",TYPE_PASSWORD);

      if (Password == ThisPass)
      {
         LockB_State = false;
         edtBackupFile->ReadOnly = false;
      }
   }
   else
   {
      LockB_State = true;
      edtBackupFile->ReadOnly = true;
   }

   pgTabsChange(Sender);
}

//---------------------------------------------------------------------------
// User clicked on Full Restore on the Restore Tab
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::rbFullClick(TObject *Sender)
{
   int  idx1;

   lvTables->Enabled = false;
   btnAllB->Enabled  = false;

   for (idx1=0;idx1<lvTables->Items->Count;idx1++)
      lvTables->Items->Item[idx1]->Checked = true;

   btnCancelB->Default  = false;
   btnProcessB->Default = true;
   btnProcessB->Enabled = true;
}

//---------------------------------------------------------------------------
// User clicked on Choose what to Restore on the Restore tab
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::rbPartialClick(TObject *Sender)
{
   int  idx1;
   bool Found = false;

   lvTables->Enabled = true;
   btnAllB->Enabled  = true;

//--- Check whether any items have been selected

   for (idx1=0;idx1<lvTables->Items->Count;idx1++)
   {
      if (lvTables->Items->Item[idx1]->Checked == true)
      {
         Found = true;
         break;
      }
   }

   btnProcessB->Enabled = Found;
   btnCancelB->Default  = !Found;
   btnProcessB->Default = Found;
}

//---------------------------------------------------------------------------
// User clicked on the Toggle All button on the Restore tab
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnAllBClick(TObject *Sender)
{
   int idx1;

   Selected = !Selected;

   for (idx1=0;idx1<lvTables->Items->Count;idx1++)
      lvTables->Items->Item[idx1]->Checked = Selected;
}

//---------------------------------------------------------------------------
// User selected/unselected an item in the tables listview on the Restore tab
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::lvTablesItemChecked(TObject *Sender, TListItem *Item)
{
   int  idx1;
   bool Found = false;

//--- Check whether any items have been selected

   for (idx1=0;idx1<lvTables->Items->Count;idx1++)
   {
      if (lvTables->Items->Item[idx1]->Checked == true)
      {
         Found = true;
         break;
      }
   }

   btnProcessB->Enabled = Found;
   btnCancelB->Default  = !Found;
   btnProcessB->Default = Found;
}

//---------------------------------------------------------------------------
// Function to extract meta data from the backup file
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::GetList(AnsiString FileName)
{
   AnsiString   ThisLine;
   TStringList *FirstLine, *Tokens;

//--- Load the entire backup file into memory then extract the first line

   ImportList->LoadFromFile(FileName);
   ThisLine = ImportList->Strings[0];

//--- Set up to extract the tokens in the First line

   FirstLine = new TStringList;
   FirstLine->Delimiter = '|';
   FirstLine->DelimitedText = ThisLine;
   Tokens = new TStringList;
   Tokens->AddStrings(FirstLine);

//--- Extract the values of the individual tokens

   edtTitle->Text   = Tokens->Strings[0].SubString(8,99);
   edtDate->Text    = Tokens->Strings[1].SubString(6,99);
   edtTime->Text    = Tokens->Strings[2].SubString(6,99);
   edtVersion->Text = Tokens->Strings[3].SubString(9,99);
   edtType->Text    = Tokens->Strings[4].SubString(6,99);
   edtMode->Text    = Tokens->Strings[5].SubString(6,99);
   RestoreTables    = Tokens->Strings[6].SubString(8,1024);

//--- Extract the list of tablesnames

   FirstLine->Delimiter = ',';
   FirstLine->DelimitedText = RestoreTables;
   TableList->AddStrings(FirstLine);

   FirstLine->Clear();
   Tokens->Clear();
   delete FirstLine;
   delete Tokens;

   return;
}

//===========================================================================
//===
//=== Log Display functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User entered the details for User, Password and Host
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtUserLChange(TObject *Sender)
{
   if ((edtUserL->Text.IsEmpty() == false) && (edtPasswordL->Text.IsEmpty() == false) && (edtHostL->Text.IsEmpty() == false))
   {
      btnOpenLog->Enabled = true;
      btnProcessL->Enabled = true;
   }
   else
   {
      btnOpenLog->Enabled = false;

      dtpSDate->Enabled  = false;
      dtpSTime->Enabled  = false;
      dtpEDate->Enabled  = false;
      dtpETime->Enabled  = false;
      btnReload->Enabled = false;

      edtSearchUser->Enabled = false;
      btnSearchUser->Enabled = false;
      edtSearchDesc->Enabled = false;
      btnSearchDesc->Enabled = false;
      btnSearchBoth->Enabled = false;
      chkMatchAny->Enabled   = false;

      lvLog->Enabled          = false;
      chkAutoRefresh->Enabled = false;
      speInterval->Enabled    = false;

      btnFirst->Enabled = false;
      btnPrev->Enabled  = false;
      btnNext->Enabled  = false;
      btnLast->Enabled  = false;

      btnProcessL->Enabled = false;
   }
}

//---------------------------------------------------------------------------
// User clicked on the button to load the current log
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnOpenLogClick(TObject *Sender)
{
   AnsiString S1;

//--- Connect to the supplied database

   if (DM_Connect_DB() == false)
      return;

//--- Set the Date and Time defaults

   if (DateIsSet == false)
   {
      if (SetDateTimeDef(TYPE_CURRENT) == false)
      {
         MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         Application->Terminate();
         return;
      }
      DateIsSet = true;
   }

//--- Set up the default search criteria

   SearchBoth = true;
   if (ReadAllRecs("%","%"," OR ") == false)
   {
      MessageBox(NULL,"No log records found - Click OK to continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));

//--- Recalibrate

      if (SetDateTimeDef(TYPE_CURRENT) == false)
      {
         MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         Application->Terminate();
         return;
      }

//--- Set up the default search criteria

      SearchBoth = true;
      if (ReadAllRecs("%","%"," OR ") == false)
      {
         MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         Application->Terminate();
         return;
      }
   }

   btnLastClick(Sender);

//--- Enable the fields that may now be used

   dtpSDate->Enabled  = true;
   dtpSTime->Enabled  = true;
   dtpEDate->Enabled  = true;
   dtpETime->Enabled  = true;
   btnReload->Enabled = true;

   edtSearchUser->Enabled = true;
   btnSearchUser->Enabled = true;
   edtSearchDesc->Enabled = true;
   btnSearchDesc->Enabled = true;
   btnSearchBoth->Enabled = true;
   chkMatchAny->Enabled   = true;

   lvLog->Enabled          = true;
   chkAutoRefresh->Enabled = true;
   speInterval->Enabled    = true;

//--- Clear the Archive File input field - this will automatically turn off
//--- ArchiveActive

   edtArchive->Clear();
}

//---------------------------------------------------------------------------
// User entered a Log Archive file name
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtArchiveChange(TObject *Sender)
{
   if (edtArchive->Text.IsEmpty() == true)
      ArchiveActive = false;
   else
      ArchiveActive = true;
}

/*
//---------------------------------------------------------------------------
// User clicked on the button to open an archive file
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnOpenLClick(TObject *Sender)
{

//--- Select an Archive File

   dlgOpen->DefaultExt = ".lla";
   dlgOpen->Filter = "LPMS Log Archive (*.lla)|*.lla|All Files (*.*)|*.*";
   dlgOpen->FilterIndex = 1;

   if (dlgOpen->Execute() == false)
      return;

   edtArchive->Text = dlgOpen->FileName;

//--- Set the Date and Time defaults

   if (DateIsSet == false)
   {
      if (SetDateTimeDef(TYPE_ARCHIVE) == false)
      {
         MessageBox(NULL,"No log records found\n\nSelect a different Log Archive or adjust the Start and End Dates/Times","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return;
      }
      DateIsSet = true;
   }

//--- Set up the default search criteria

   SearchBoth = true;
   if (ReadAllLogRecs("%","%"," OR ") == false)
   {
      MessageBox(NULL,"No log records found - Click OK to continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));

//--- Recalibrate

      if (SetDateTimeDef(TYPE_ARCHIVE) == false)
      {
         MessageBox(NULL,"No log records found\n\nSelect a different Log Archive or adjust the Start and End Dates/Times","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return;
      }

//--- Set up the default search criteria

      SearchBoth = true;
      if (ReadAllLogRecs("%","%"," OR ") == false)
      {
         MessageBox(NULL,"No log records found\n\nSelect a different Log Archive or adjust the Start and End Dates/Times","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return;
      }
   }

   btnLastClick(Sender);

//--- Enable the fields that may now be used

   dtpSDate->Enabled  = true;
   dtpSTime->Enabled  = true;
   dtpEDate->Enabled  = true;
   dtpETime->Enabled  = true;
   btnReload->Enabled = true;

   edtSearchUser->Enabled = true;
   btnSearchUser->Enabled = true;
   edtSearchDesc->Enabled = true;
   btnSearchDesc->Enabled = true;
   btnSearchBoth->Enabled = true;
   chkMatchAny->Enabled   = true;

   lvLog->Enabled          = true;
   chkAutoRefresh->Enabled = true;
   speInterval->Enabled    = true;

//--- Disable AutoRefresh when displaying an archive

   chkAutoRefresh->Enabled = false;
   chkAutoRefresh->Checked = false;

//--- Enable the Process buttons

   btnProcessL->Enabled = true;
}
*/

//---------------------------------------------------------------------------
// User clicked on the button embedded in the Archive File field
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtArchiveClickBtn(TObject *Sender)
{
   edtArchive->Filter      = "LPMS Log Archive (*.lla)|*.lla|All Files (*.*)|*.*";
   edtArchive->DefaultExt  = ".lla";
   edtArchive->FilterIndex = 1;
}

//---------------------------------------------------------------------------
// User selected an Archive File or clicked on Cancel
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::edtArchiveDialogExit(TObject *Sender, bool ExitOK)
{
   if (ExitOK == false)
      return;
//
//   edtArchive->Text = dlgOpen->FileName;

//--- Set the Date and Time defaults

   if (DateIsSet == false)
   {
      if (SetDateTimeDef(TYPE_ARCHIVE) == false)
      {
         MessageBox(NULL,"No log records found\n\nSelect a different Log Archive or adjust the Start and End Dates/Times","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return;
      }
      DateIsSet = true;
   }

//--- Set up the default search criteria

   SearchBoth = true;
   if (ReadAllLogRecs("%","%"," OR ") == false)
   {
      MessageBox(NULL,"No log records found - Click OK to continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));

//--- Recalibrate

      if (SetDateTimeDef(TYPE_ARCHIVE) == false)
      {
         MessageBox(NULL,"No log records found\n\nSelect a different Log Archive or adjust the Start and End Dates/Times","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return;
      }

//--- Set up the default search criteria

      SearchBoth = true;
      if (ReadAllLogRecs("%","%"," OR ") == false)
      {
         MessageBox(NULL,"No log records found\n\nSelect a different Log Archive or adjust the Start and End Dates/Times","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return;
      }
   }

   btnLastClick(Sender);

//--- Enable the fields that may now be used

   dtpSDate->Enabled  = true;
   dtpSTime->Enabled  = true;
   dtpEDate->Enabled  = true;
   dtpETime->Enabled  = true;
   btnReload->Enabled = true;

   edtSearchUser->Enabled = true;
   btnSearchUser->Enabled = true;
   edtSearchDesc->Enabled = true;
   btnSearchDesc->Enabled = true;
   btnSearchBoth->Enabled = true;
   chkMatchAny->Enabled   = true;

   lvLog->Enabled          = true;
   chkAutoRefresh->Enabled = true;
   speInterval->Enabled    = true;

//--- Disable AutoRefresh when displaying an archive

   chkAutoRefresh->Enabled = false;
   chkAutoRefresh->Checked = false;

//--- Enable the Process buttons

   btnProcessL->Enabled = true;
}

//---------------------------------------------------------------------------
// User clicked on the Reload button
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnReloadClick(TObject *Sender)
{
   AnsiString S1;

   if (ArchiveActive == true)
   {
      //
   }
   else
   {
//--- Connect to the supplied database

      if (DM_Connect_DB() == false)
         return;

      edtSearchUser->Text = "";
      edtSearchDesc->Text = "";
      SearchUser = SearchDesc = SearchBoth = false;
      chkMatchAny->Checked = false;

//--- Set up the default search criteria

      SearchBoth = true;
      if (ReadAllRecs("%","%"," OR ") == false)
      {
         MessageBox(NULL,"No log records found - Click OK to continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));

//--- Recalibrate

         if (SetDateTimeDef(TYPE_CURRENT) == false)
         {
            MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            Application->Terminate();
            return;
         }

//--- Set up the default search criteria

         SearchBoth = true;
         if (ReadAllRecs("%","%"," OR ") == false)
         {
            MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            Application->Terminate();
            return;
         }
      }

      btnLastClick(Sender);
   }
}

//---------------------------------------------------------------------------
// User clicked on the button to go to the first item
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnFirstClick(TObject *Sender)
{
   if (lvLog->Items->Count > 0)
   {
      lvLog->ItemIndex = 0;
      lvLog->Items->Item[lvLog->ItemIndex]->Focused;
   }

   MoveItems();
}

//---------------------------------------------------------------------------
// User clicked on the button to go to the previous item
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnPrevClick(TObject *Sender)
{
   if (lvLog->Items->Count > 0)
   {
      lvLog->ItemIndex -= 1;
      lvLog->Items->Item[lvLog->ItemIndex]->Focused;
   }

   MoveItems();
}

//---------------------------------------------------------------------------
// User clicked on the button to go to the next item
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnNextClick(TObject *Sender)
{
   if (lvLog->Items->Count > 0)
   {
      lvLog->ItemIndex += 1;
      lvLog->Items->Item[lvLog->ItemIndex]->Focused;
   }

   MoveItems();
}

//---------------------------------------------------------------------------
// User clicked on the button to go to the last item
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnLastClick(TObject *Sender)
{
   if (lvLog->Items->Count > 0)
   {
      lvLog->ItemIndex = lvLog->Items->Count - 1;
      lvLog->Items->Item[lvLog->ItemIndex]->Focused;
   }

   MoveItems();
}

//---------------------------------------------------------------------------
// Common function to facilitate movement through the Billing records
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::MoveItems(void)
{
   int         idx, idx2, Dummy;
   TListItem  *ThisItem;

   if (lvLog->Items->Count > 0)
   {
      ThisItem = lvLog->Items->Item[lvLog->ItemIndex];
      lvLog->Items->Item[lvLog->ItemIndex]->MakeVisible(false);

//--- Populate the fields using the selected record

      edtDateL->Text        = ThisItem->Caption;
      edtTimeL->Text        = ThisItem->SubItems->Strings[0];
      edtUser->Text         = ThisItem->SubItems->Strings[1];
      edtDescriptionL->Text = ThisItem->SubItems->Strings[2];
   }

   if (lvLog->ItemIndex > 0)
   {
      btnFirst->Enabled = true;
      btnPrev->Enabled  = true;
   }
   else
   {
      btnFirst->Enabled = false;
      btnPrev->Enabled  = false;
   }

   if (lvLog->ItemIndex < (lvLog->Items->Count - 1))
   {
      btnNext->Enabled = true;
      btnLast->Enabled = true;
   }
   else
   {
      btnNext->Enabled = false;
      btnLast->Enabled = false;
   }
}

//---------------------------------------------------------------------------
// User clicked on the 'Load' button on the Log Display tab
//----------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnProcessLClick(TObject *Sender)
{
//--- If ArchiveActive is true then we should possibly load an archive file,
//--- however if any of the User, Password or Host fields are not empty then
//--- we rather will load the current log

   if ((ArchiveActive == true) && ((edtUserL->Text.IsEmpty() == true) || (edtPasswordL->Text.IsEmpty() == true) || (edtHostL->Text.IsEmpty() == true)))
   {
      if (edtArchive->Text.IsEmpty() == false)
         edtArchiveClickBtn(Sender);
   }
   else
   {
      if ((edtUserL->Text.IsEmpty() == false) && (edtPasswordL->Text.IsEmpty() == false) && (edtHostL->Text.IsEmpty() == false))
         btnOpenLogClick(Sender);
   }
}

//---------------------------------------------------------------------------
// User clicked on the Lock/Unlock button on the Display Log Tab
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnLockLClick(TObject *Sender)
{
   UnicodeString Password;

//--- Check whether we can do the unlock - if edtSearchUser is disabled then
//--- the ListView content is not valid

   if (LockL_State == true)
   {
      if (edtSearchUser->Enabled == false)
         return;
   }

//--- Now go ahead and do the Lock/Unlock

   if (LockL_State == true)
   {
      Password = InputQueryM("Legal Practise Management System","Pass phrase:",TYPE_PASSWORD);

      if (Password == ThisPass)
      {
         LockL_State = false;

         btnLockL->Visible   = false;
         btnUnlockL->Visible = true;
      }
   }
   else
   {
      LockL_State = true;

      btnLockL->Visible   = true;
      btnUnlockL->Visible = false;
   }

   btnAll->Enabled     = !LockL_State;
   btnArchive->Enabled = !LockL_State;
}

//---------------------------------------------------------------------------
// The user selected/deseleted the checkbox to refresh the log display
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::chkAutoRefreshClick(TObject *Sender)
{
   if (chkAutoRefresh->Checked == true)
   {
      timTimer->Interval = speInterval->Value * 1000;
      timTimer->Enabled = true;
   }
   else
      timTimer->Enabled = false;
}

//---------------------------------------------------------------------------
// User adjusted the auto refresh interval. Toggle the AutoRefresh setting
// to ensure the new interval is activated
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::speIntervalChange(TObject *Sender)
{
   chkAutoRefresh->Checked = !chkAutoRefresh->Checked;
   chkAutoRefresh->Checked = !chkAutoRefresh->Checked;
}

//---------------------------------------------------------------------------
// The Timer to update the log display popped
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::timTimerTimer(TObject *Sender)
{
   DateIsSet = false;
   btnOpenLogClick(Sender);
}

//---------------------------------------------------------------------------
// User clicked on the Select/Deselect All button next to the ListView
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnAllClick(TObject *Sender)
{
   int idx;

   Sema = !Sema;

   for (idx = 0; idx < lvLog->Items->Count; idx++)
      lvLog->Items->Item[idx]->Checked = Sema;
}

//---------------------------------------------------------------------------
// User clicked on the Archive button next to the ListView
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnArchiveClick(TObject *Sender)
{
   int          idx1, SaveIdx;
   bool         Selected = false;
   FILE        *LogFile;
   AnsiString   S1, ThisLine, FileName;
   TStringList *SaveList;

//--- We cannot do an archive if the ListView contains the contents of an Archive

   if (ArchiveActive == true)
      return;

//--- Check whether anything is selected

   for (idx1 = 0; idx1 < lvLog->Items->Count; idx1++)
   {
      if (lvLog->Items->Item[idx1]->Checked == true)
      {
         Selected = true;
         break;
      }
   }

   if (Selected == false)
      return;

//--- If we get here then there is at least one log record selected

   sdArchive->FileName   = FormatDateTime("yyyyMMdd",Now()) + " - LPMS Log Archive (" + ThisDBPrefix + ").lla";

   if (sdArchive->Execute() == true)
      FileName = sdArchive->FileName;
   else
      return;

   LogFile = fopen(FileName.c_str(),"w");
   SaveList = new TStringList;

   for (idx1 = 0; idx1 < lvLog->Items->Count; idx1++)
   {
      if (lvLog->Items->Item[idx1]->Checked == true)
      {
         stMsg->Caption = "Processing: '" + lvLog->Items->Item[idx1]->Caption + " " + lvLog->Items->Item[idx1]->SubItems->Strings[0] + " " + lvLog->Items->Item[idx1]->SubItems->Strings[1] + " " + lvLog->Items->Item[idx1]->SubItems->Strings[2] + "'";
         stMsg->Refresh();

         SaveList->Add(lvLog->Items->Item[idx1]->Caption);
         SaveList->Add(lvLog->Items->Item[idx1]->SubItems->Strings[0]);
         SaveList->Add(lvLog->Items->Item[idx1]->SubItems->Strings[1]);
         SaveList->Add(lvLog->Items->Item[idx1]->SubItems->Strings[2]);
         SaveList->Add(lvLog->Items->Item[idx1]->SubItems->Strings[3]);
         SaveList->Add(lvLog->Items->Item[idx1]->SubItems->Strings[4]);
         SaveList->Add(lvLog->Items->Item[idx1]->SubItems->Strings[5]);
         SaveList->Add(lvLog->Items->Item[idx1]->SubItems->Strings[6]);
         SaveList->Add(lvLog->Items->Item[idx1]->SubItems->Strings[7]);

         ThisLine = Assemble(SaveList);
         ThisLine += '\n';

         fputs(ThisLine.c_str(),LogFile);
         SaveList->Clear();
      }
   }

//--- Close the archive file and delete the dynamic StringList

   fclose(LogFile);
   delete SaveList;

//--- Now delete the checked records then refresh the display
//--- Connect to the supplied database

   if (DM_Connect_DB() == false)
      return;

   for (idx1 = 0; idx1 < lvLog->Items->Count; idx1++)
   {
      if (lvLog->Items->Item[idx1]->Checked == true)
         DeleteItem(StrToInt(lvLog->Items->Item[idx1]->SubItems->Strings[7]));
   }

   SaveIdx = lvLog->ItemIndex;
   DateIsSet = false;
   btnOpenLogClick(Sender);

   if (SaveIdx >= lvLog->Items->Count)
      lvLog->ItemIndex = lvLog->Items->Count - 1;
   else
      lvLog->ItemIndex = SaveIdx;

   lvLogClick(Sender);
}

//---------------------------------------------------------------------------
// User clicked on the Listview
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::lvLogClick(TObject *Sender)
{
//--- Check whether anything was selected

   if (lvLog->ItemIndex == -1)
      return;

   MoveItems();
   edtUser->SetFocus();
}

//---------------------------------------------------------------------------
// User clicked on the button to filter by User
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnSearchUserClick(TObject *Sender)
{

   if (ArchiveActive == true)
   {
      //
   }
   else
   {

//--- Connect to the supplied database

      if (DM_Connect_DB() == false)
         return;

      SearchBoth = SearchDesc = false;
      SearchUser = true;

//--- Filter records by the value supplied in the SearchUser field. If the
//--- search fails then display a message and do another search on all records

      if (ReadAllRecs("%" + edtSearchUser->Text + "%","%",NULL) == false)
      {
         MessageBox(NULL,"No log records found - Click OK to continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));

//--- Recalibrate

         if (SetDateTimeDef(TYPE_CURRENT) == false)
         {
            MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            Application->Terminate();
            return;
         }

//--- Set up the default search criteria

         SearchBoth = true;
         if (ReadAllRecs("%","%"," OR ") == false)
         {
            MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            Application->Terminate();
            return;
         }
      }

      btnLastClick(Sender);
   }
}

//---------------------------------------------------------------------------
// User clicked on the button to filter by Description
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnSearchDescClick(TObject *Sender)
{

   if (ArchiveActive == true)
   {
      //
   }
   else
   {

//--- Connect to the supplied database

      if (DM_Connect_DB() == false)
         return;

      SearchBoth = SearchUser = false;
      SearchDesc = true;

//--- Filter records by the value supplied in the SearchDesc field. If the
//--- search fails then display a message and do another search on all records

      if (ReadAllRecs("%","%" + edtSearchDesc->Text + "%",NULL) == false)
      {
         MessageBox(NULL,"No log records found - Click OK to continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));

//--- Recalibrate

         if (SetDateTimeDef(TYPE_CURRENT) == false)
         {
            MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            Application->Terminate();
            return;
         }

//--- Set up the default search criteria

         SearchBoth = true;
         if (ReadAllRecs("%","%"," OR ") == false)
         {
            MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            Application->Terminate();
            return;
         }
      }

      btnLastClick(Sender);
   }
}

//---------------------------------------------------------------------------
// User clicked on the button to filter by both user and description
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnSearchBothClick(TObject *Sender)
{
   AnsiString S2;

   if (ArchiveActive == true)
   {
      //
   }
   else
   {
      SearchDesc = SearchUser = false;
      SearchBoth = true;

      S2 = chkMatchAny->Checked == true ? " OR " : " AND ";

//--- Connect to the supplied database

      if (DM_Connect_DB() == false)
         return;

//--- Filter records by the value supplied in both the SearchUser field and the
//--- SearchDesc field. If the search fails then display a message and do
//--- another search on all records

      if (ReadAllRecs("%" + edtSearchUser->Text + "%","%" + edtSearchDesc->Text + "%",S2) == false)
      {
         MessageBox(NULL,"No log records found - Click OK to continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));

//--- Recalibrate

         if (SetDateTimeDef(TYPE_CURRENT) == false)
         {
            MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            Application->Terminate();
            return;
         }

//--- Set up the default search criteria

         SearchBoth = true;
         if (ReadAllRecs("%","%"," OR ") == false)
         {
            MessageBox(NULL,"No log records found - FirstRun cannot continue...","Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
            Application->Terminate();
            return;
         }
      }

      btnLastClick(Sender);
   }
}

//===========================================================================
//===
//=== Common functions
//===
//===========================================================================

//---------------------------------------------------------------------------
// User clicked on the Close button
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::btnCancelRClick(TObject *Sender)
{
   Close();
}

//---------------------------------------------------------------------------
// Function to Reqeust a PassPhrase from the User
//---------------------------------------------------------------------------
AnsiString __fastcall TFLPMS_FirstRunApp::InputQueryM(AnsiString Caption, AnsiString Question, int DispType)
{
   FldInputQueryM = new TFldInputQueryM(Application);

   FldInputQueryM->Caption             = Caption;
   FldInputQueryM->edtInput->Clear();
   FldInputQueryM->lblCaption->Caption = Question;

   if (DispType == TYPE_PASSWORD)
      FldInputQueryM->edtInput->PasswordChar = '*';

   FLPMS_FirstRunApp->Hide();
   FldInputQueryM->ShowModal();
   FLPMS_FirstRunApp->Show();

   delete FldInputQueryM;

   return(Result);
}

//---------------------------------------------------------------------------
// Function used by Log Display to connect to a datastore
//---------------------------------------------------------------------------
bool __fastcall TFLPMS_FirstRunApp::DM_Connect_DB(void)
{
   AnsiString S1;

//--- Connect to the supplied database

      CSMySQL  = "Provider=MSDASQL.1;Persist Security Info=False;Data Source=BSD_MySQL;User ID=" + edtUserL->Text + ";Password=" + edtPasswordL->Text + ";Server=";
      HostName = edtHostL->Text;

      if ((DM_Open_Connection()) == false)
      {
         MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return (false);
      }

//--- Select the database associated with the DBPRefix

      S1 = "USE " + ThisDBPrefix + "_LPMS";
      if (DM_Put_DB(S1,TYPE_OTHER) == false)
      {
         MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return(false);
      }

      return(true);
}

//---------------------------------------------------------------------------
// Function to open a connection to the datastore
//---------------------------------------------------------------------------
bool __fastcall TFLPMS_FirstRunApp::DM_Open_Connection(void)
{
   try
   {
      Query1->Close();

      MySQLCon->Close();
      MySQLCon->ConnectionString = CSMySQL + HostName;
      Query1->Connection = MySQLCon;

      MySQLCon->Open();
   }
   catch (Exception &Err)
   {
      ErrMsg = Err.Message;
      return (false);
   }
   return(true);
}

//---------------------------------------------------------------------------
// Function to access the Database
//---------------------------------------------------------------------------
bool __fastcall TFLPMS_FirstRunApp::DM_Put_DB(AnsiString S1, int RunType)
{
   if (RunType == TYPE_SELECT)
   {
      try
      {
         Query1->Close();
         Query1->SQL->Text = S1;
         Query1->Open();
      }
      catch (Exception &Err)
      {
         ErrMsg = Err.Message;
         if (pgTabs->Pages[3]->Visible == true) stProgress->Caption = "";
         return (false);
      }
   }
   else
   {
      try
      {
         Query1->Close();
         Query1->SQL->Text = S1;
         Query1->ExecSQL();
      }
      catch (Exception &Err)
      {
         ErrMsg = Err.Message;
         if (pgTabs->Pages[3]->Visible == true) stProgress->Caption = "";
         return (false);
      }
   }
   return(true);
}

//---------------------------------------------------------------------------
// Function to insert the LPMS signature and the Default Administrator
//---------------------------------------------------------------------------
bool __fastcall TFLPMS_FirstRunApp::DM_PutSignature(void)
{
   AnsiString  S1, ThisVersion;

   ThisVersion = "3.2.1";

   ShortDateFormat = "yyyy/MM/dd";
   DateSeparator   = '/';

   S1 = "INSERT INTO lpms (Signature, Version, VATRegistered, UniqueNum, CpyName, Create_By, Create_On, Create_At) Values('Legal Practise Management System - LPMS', '" +
        ThisVersion + "', 0, 1, '" + edtCpyName->Text + "', '" +
        edtUserName->Text + "', '" + FormatDateTime("yyyy/MM/dd",Now()) +
        "', '" + FormatDateTime("hh:nn:ss",Now()) + "')";

   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return(false);
   }

   S1 = "INSERT INTO control (Control_UserID, Control_Password, Control_Name, Control_UserType, Control_FeeEarner, Control_Unique, Create_By, Create_Date, Create_Time) Values('Administrator', 'ƒÐâÎ±ÛÔâ×ÇÞØ', 'Default System Administrator', 'Administrator', 0, 1, '" +
        edtUserName->Text + "', '" + FormatDateTime("yyyy/MM/dd",Now()) +
        "', '" + FormatDateTime("hh:nn:ss",Now()) + "')";

   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return(false);
   }

   return(true);
}

//---------------------------------------------------------------------------
// Function to set up the default search criteria on the Log Display tab
//---------------------------------------------------------------------------
bool __fastcall TFLPMS_FirstRunApp::SetDateTimeDef(int Type)
{
   int          NumLines = 0;
   char         LogLine[4096] = "";
   AnsiString   S1, FileName;
   FILE        *LogFile;

   if (Type == TYPE_ARCHIVE)
   {

//--- Read the the first record from the Archive

//      FileName = dlgOpen->FileName;
      FileName = edtArchive->Text;
      LogFile = fopen(FileName.c_str(),"r");

      if (LogFile != NULL)
      {
         fgets(LogLine,4096,LogFile);
         if (LogLine != NULL)
         {
            LogList = Disassemble(LogLine);
            dtpSDate->Date = StrToDate(LogList->Strings[0]);
            dtpSTime->Time = StrToTime(LogList->Strings[1]);
            dtpEDate->Date = Now();
            dtpETime->Time = Now();

            NumLines++;
         }
      }

      fclose(LogFile);

      if (NumLines == 0)
         return(false);
   }
   else
   {

//--- Read all records from the log to determine the date of the first record

      S1 = "SELECT Log_Date FROM log ORDER BY Log_Date ASC";

      if (DM_Put_DB(S1,TYPE_SELECT) == false)
      {
         MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
         return(false);
      }

//--- If the log is empty then we must return to avoid errors

      if (Query1->RecordCount == 0)
         return(false);

//--- Get the date of the first log record

      Query1->First();

      ShortDateFormat = "yyyy/MM/dd";
      DateSeparator   = '/';

      dtpSDate->Date = StrToDate(Query1->FieldByName("Log_Date")->AsString);
      dtpSTime->Time = StrToTime("00:00:00");
      dtpEDate->Date = Now();
      dtpETime->Time = Now();
   }

   return(true);
}

//---------------------------------------------------------------------------
// Function to read all the log records into the ListView. S2 indicates
// whether the filter should match both User and Description
//---------------------------------------------------------------------------
bool __fastcall TFLPMS_FirstRunApp::ReadAllRecs(AnsiString UserStr, AnsiString DescStr, AnsiString S2)
{
   AnsiString   S1, S3, SDateTime, EDateTime;
   TListItem   *ThisList;

//--- Prepare the Date and Time strings for demarcating the information to show

   ShortDateFormat = "yyyy/MM/dd";
   DateSeparator   = '/';

   SDateTime = FormatDateTime("yyyy/MM/dd",dtpSDate->Date) + FormatDateTime("HH:mm:ss",dtpSTime->Time);
   EDateTime = FormatDateTime("yyyy/MM/dd",dtpEDate->Date) + FormatDateTime("HH:mm:ss",dtpETime->Time);

//--- Determine whether we should filter on User, Description or Both

   if (SearchBoth == true)
   {
      S3 = "(Log_User LIKE '" + UserStr + "'" + S2 + "Log_Activity LIKE '" +
           DescStr + "')";
   }
   else if (SearchUser == true)
   {
      S3 = "(Log_User LIKE '" + UserStr + "')";
   }
   else
   {
      S3 = "(Log_Activity LIKE '" + DescStr + "')";
   }

   SearchBoth = SearchUser = SearchDesc = false;

//--- Load the data

   S1 = "SELECT * FROM log WHERE (CONCAT(Log_Date, Log_Time) >= '" +
        SDateTime + "' AND CONCAT(Log_Date, Log_Time) <= '" + EDateTime +
        "') AND " + S3 + " ORDER BY CONCAT(Log_Date, Log_Time) ASC";

   if (DM_Put_DB(S1,TYPE_SELECT) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return(false);
   }

//--- Return false if no records were found

   if (Query1->RecordCount == 0)
      return(false);

   Query1->First();
   lvLog->Clear();
   Sema = false;

   while (Query1->Eof == false)
   {
      ThisList = lvLog->Items->Add();

      ThisList->Caption = Query1->FieldByName("Log_Date")->AsString;
      ThisList->SubItems->Add(Query1->FieldByName("Log_Time")->AsString);
      ThisList->SubItems->Add(ReplaceQuote(Query1->FieldByName("Log_User")->AsString,TYPE_READ));
      ThisList->SubItems->Add(ReplaceQuote(Query1->FieldByName("Log_Activity")->AsString,TYPE_READ));
      ThisList->SubItems->Add(ReplaceQuote(Query1->FieldByName("Create_By")->AsString,TYPE_READ));
      ThisList->SubItems->Add(Query1->FieldByName("Create_Date")->AsString);
      ThisList->SubItems->Add(Query1->FieldByName("Create_Time")->AsString);
      ThisList->SubItems->Add(ReplaceQuote(Query1->FieldByName("TimeStamp")->AsString,TYPE_READ));
      ThisList->SubItems->Add(Query1->FieldByName("Log_Key")->AsString);

      Query1->Next();
   }

   stMsg->Caption = IntToStr(lvLog->Items->Count) + " Log Record" + (IntToStr(lvLog->Items->Count) == 1 ? " in Current Log" : "s in Current Log");
   return(true);
}

//---------------------------------------------------------------------------
// Function to read all the log records from an Archive into the ListView.
// S2 indicates whether the filter should match both User and Description
//---------------------------------------------------------------------------
bool __fastcall TFLPMS_FirstRunApp::ReadAllLogRecs(AnsiString UserStr, AnsiString DescStr, AnsiString S2)
{
   int          NumLines = 0;
   char         LogLine[4096] = "";
   AnsiString   FileName, SDateTime, EDateTime, ThisDateTime;
   FILE        *LogFile;
   TListItem   *ThisList;

//--- Build the Date and Time Filters

   ShortDateFormat = "yyyy/MM/dd";
   DateSeparator   = '/';

   SDateTime = FormatDateTime("yyyy/MM/dd",dtpSDate->Date) + FormatDateTime("HH:mm:ss",dtpSTime->Time) + ".000";
   EDateTime = FormatDateTime("yyyy/MM/dd",dtpEDate->Date) + FormatDateTime("HH:mm:ss",dtpETime->Time) + ".999";

//--- Read the archived records into the ListView

//   FileName = dlgOpen->FileName;
   FileName = edtArchive->Text;
   LogFile = fopen(FileName.c_str(),"r");

   if (LogFile != NULL)
   {

      lvLog->Clear();
      Sema = false;

      while (fgets(LogLine,4096,LogFile) != 0x00)
      {
         LogList = Disassemble(LogLine);

//--- Build the Date and Time constraints

         ThisDateTime = LogList->Strings[0] + LogList->Strings[1];

         if ((ThisDateTime >= SDateTime) && (ThisDateTime <= EDateTime))
         {
            ThisList = lvLog->Items->Add();

            ThisList->Caption = LogList->Strings[0];
            ThisList->SubItems->Add(LogList->Strings[1]);
            ThisList->SubItems->Add(ReplaceQuote(LogList->Strings[2],TYPE_READ));
            ThisList->SubItems->Add(ReplaceQuote(LogList->Strings[3],TYPE_READ));
            ThisList->SubItems->Add(ReplaceQuote(LogList->Strings[4],TYPE_READ));
            ThisList->SubItems->Add(LogList->Strings[5]);
            ThisList->SubItems->Add(LogList->Strings[6]);
            ThisList->SubItems->Add(ReplaceQuote(LogList->Strings[7],TYPE_READ));
            ThisList->SubItems->Add(LogList->Strings[8]);

            NumLines++;
         }
      }
      fclose(LogFile);
   }

   if (NumLines == 0)
      return(false);

   stMsg->Caption = IntToStr(lvLog->Items->Count) + " Log Record" + (IntToStr(lvLog->Items->Count) == 1 ? " in '" : "s in '") + edtArchive->Text + "'";
   return(true);
}

//---------------------------------------------------------------------------
// Function to delete a given log record (used after successful archive)
//---------------------------------------------------------------------------
bool __fastcall TFLPMS_FirstRunApp::DeleteItem(int Key)
{
   AnsiString S1;

   S1 = "DELETE FROM log WHERE Log_Key = " + IntToStr(Key);

//--- Delete the Record

   if (DM_Put_DB(S1,TYPE_OTHER) == false)
   {
      MessageBox(NULL,AnsiString("Unexpected error: " + ErrMsg).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MB_ICONSTOP|MB_SYSTEMMODAL));
      return(false);
   }

   return(true);
}

//---------------------------------------------------------------------------
// Process the response from the Server
//---------------------------------------------------------------------------
void __fastcall TFLPMS_FirstRunApp::ProcessResponse(AnsiString Response)
{

   int               idx1, MsgType;
   AnsiString        ThisPrefix, T1, T2;
   TRegistryIniFile *RegIni;

//--- Disassemble the response from the Server

   RespList = new TStringList;
   RespList = Disassemble(Response.c_str(),TYPE_CODED);

   ShortDateFormat = "yyyy/MM/dd";
   DateSeparator   = '/';

   if ((RespList->Strings[0] == "0") || (RespList->Strings[0] == "1"))
   {
      idx1 = 1;

      if (RespList->Strings[0] == "0")
         MsgType = MB_ICONINFORMATION;
      else
         MsgType = MB_ICONSTOP;

//--- Process the response(s)

      while (idx1 < RespList->Count)
      {
         switch (StrToInt(RespList->Strings[idx1]))
         {
            case 1:
               RegIni = new TRegistryIniFile(KeepRegString);
               RegIni->WriteString("Preferences",RespList->Strings[idx1 + 1],RespList->Strings[idx1 + 2]);
               delete RegIni;
               idx1 += 3;
               break;

            case 2:
               MessageBox(NULL,AnsiString(RespList->Strings[idx1 + 1]).c_str(),"Legal Practise Management System - FirstRun",(MB_OK|MsgType|MB_SYSTEMMODAL));
               idx1 += 2;
               break;
         }
      }

//--- Retrieve the newly generated Key from the Registry if registration was successful

      if (RespList->Strings[0] == "0")
      {
   	   RegIni = new TRegistryIniFile(KeepRegString);

         ThisPrefix = RegIni->ReadString("Preferences","DBPrefix","");
         UserKey    = RegIni->ReadString("Preferences","Key","");

#ifdef NEW_ENCODING
         DBPrefix = Vignere(CYPHER_ENC,AnsiString(edtPrefix->Text + FormatDateTime("yyyy/mm/dd",Now())).c_str(),ThisPass.c_str());
         T1 = DBPrefix.SubString(1,6);
         T2 = DBPrefix.SubString(7,99);
         DBPrefix = T1 + EncodePass(T2);
#else
         DBPrefix = jvCipher->EncodeString(ThisPass,(edtPrefix->Text + FormatDateTime("yyyy/mm/dd",Now())));
#endif

         RegIni->WriteString("Preferences","DBPrefix",DBPrefix);

         delete RegIni;

         edtPrefix->Text = ThisPrefix;
         edtKey->Text    = UserKey;
      }
   }
    delete RespList;
}

//---------------------------------------------------------------------------
// Procedure to Disassemble a Server message
//---------------------------------------------------------------------------
TStringList *TFLPMS_FirstRunApp::Disassemble(char *Str, int Type)
{
   int          idx1,idx2;
   char         Delim = SERVER_DELIM;
   char         Buf[BUFFER_LEN + 1];
   AnsiString   ThisStr, PlainStr;
   TStringList *ThisList;

   ThisList = new TStringList;

   if (Type == TYPE_CODED)
   {
      ThisStr = Str;
      PlainStr = Vignere(CYPHER_DEC,ThisStr.c_str(),ThisPass.c_str());
      strcpy(Str,PlainStr.c_str());
   }

   idx1 = 0;
   while(Str[idx1] != '\0')
   {
      idx2 = 0;
      memset(Buf,0,BUFFER_LEN + 1);

      while(Str[idx1] != Delim)
      {
         Buf[idx2++] = Str[idx1++];

         if (idx2 == BUFFER_LEN)
            Str[idx1] = Delim;
      }
      ThisList->Add(Buf);
      idx1++;
   }

   return(ThisList);
}

//---------------------------------------------------------------------------
// Function to extract and return the parameters that were passed on the
// command line when the application was invoked.
//
// An Option list of "H:L:mu:" would expect a command line similar to:
//   -H followed by a parameter e.g. -Hwww.sourcingmethods.com
//   -L followed by a parameter e.g. -L1
//   -m
//   -u followed by a parameter e.g. -uFrancois
//
// The calling function must create the following TStringList variables:
//
//   Options
//   Parms
//
// The function returns:
//
//    0 if no command line parameters were passed
//   -1 if an invalid parameter was encountered
//   The number of parameters found if no error occurs
//---------------------------------------------------------------------------
int __fastcall TFLPMS_FirstRunApp::ldOpt(int argc, char *argv[], AnsiString OptList, TStringList *Options, TStringList *Parms)
{
   int         idx1, idx2;
   bool        Found;
   AnsiString  ThisParm, ThisOption;

//--- Check whether any arguments were passed

   if (argc <= 1)
      return(0);

//--- Extract the parameters that were passed from argv

   for (idx1 = 1; idx1 < argc; idx1++)
   {
      ThisParm = argv[idx1];

//--- First character of the argument must be the switch character ('-' or '/')

      if (ThisParm.SubString(1,1) != "-" && ThisParm.SubString(1,1) != "/")
         return(-1);

//--- Extract the second character and search for it in OptList

      ThisOption = ThisParm.SubString(2,1);
      Found = false;

      for (idx2 = 1; idx2 < OptList.Length() + 1; idx2++)
      {
         if (OptList.SubString(idx2,1) == ThisOption)
         {
            Found = true;
            Options->Add(ThisOption);

//--- If this Option is followed by ":" in the OptList then a parameter is
//       expected. Extract the parameter if it is expected

            if (OptList.SubString(idx2 + 1,1) == ":")
            {
               if (ThisParm.Length() < 3)
                  return(-1);
               else
                  Parms->Add(ThisParm.SubString(3, ThisParm.Length() - 2));
            }
            else
            {
               if (ThisParm.Length() > 2)
                  return(-1);
               else
                  Parms->Add("$");
            }
            break;
         }
      }

      if (Found == false)
         return(-1);
   }

   return(Parms->Count);
}

//---------------------------------------------------------------------------
// Function to manage replacement of single quotes to avoid SQL errors
//---------------------------------------------------------------------------
AnsiString __fastcall TFLPMS_FirstRunApp::ReplaceQuote(AnsiString S1, int Type)
{
   if (Type == TYPE_READ)
   {
      S1 = AnsiReplaceStr(S1,"&quot","'");
      S1 = AnsiReplaceStr(S1,"&slash","\\");
      S1 = AnsiReplaceStr(S1,"§", "\\");        // Retained for backwards compatibility
   }
   else
   {
      S1 = AnsiReplaceStr(S1,"'","&quot");
      S1 = AnsiReplaceStr(S1,"\\","&slash");
   }

   return(S1);
}

//---------------------------------------------------------------------------
// Function to Assemble a Log entry
//---------------------------------------------------------------------------
AnsiString __fastcall TFLPMS_FirstRunApp::Assemble(TStringList *List)
{
   int        idx;
   char       Delim = '|';
   AnsiString Str;

   for (idx = 0; idx < List->Count; idx++)
   {
      Str += List->Strings[idx];
      Str += Delim;
   }
   return(Str);
}

//---------------------------------------------------------------------------
// Function to Disassemble a Log entry
//---------------------------------------------------------------------------
TStringList *TFLPMS_FirstRunApp::Disassemble(char *Str)
{
   int           idx1,idx2;
   char          Delim = '|';
   char          Buf[4096];

   LogList->Clear();

   idx1 = 0;
   while(Str[idx1] != '\0')
   {
      idx2 = 0;
      memset(Buf,0,1025);

      while(Str[idx1] != Delim)
      {
         Buf[idx2++] = Str[idx1++];

         if (idx2 == 1024)
            Str[idx1] = Delim;
      }
      LogList->Add(Buf);
      idx1++;
   }

   return(LogList);
}

//---------------------------------------------------------------------------
// Function to do a Vignere Cypher
//---------------------------------------------------------------------------
AnsiString __fastcall TFLPMS_FirstRunApp::Vignere(int Type, char Phrase[], char Key[])
{
   int        idx1, idx2;
   int        a, b, c, d, e;
   int        PhraseLen, ThisKeyLen;
   char       NewKey[256], TempKey[256], EncryptedMsg[256];
   AnsiString ThisPhrase;

   PhraseLen  = strlen(Phrase);

//--- Remove spaces from the Key and translate to upper case

   idx1 = idx2 = 0;
   while (Key[idx2] != '\0')
   {
      if (Key[idx2] == ' ')
         idx2++;
      else
         TempKey[idx1++] = toupper(Key[idx2++]);
   }

   TempKey[idx1] = '\0';
   ThisKeyLen = strlen(TempKey);

//--- Now extend or limit the Key to the same length as the Phrase

   for (idx1 = 0, idx2 = 0; idx1 < PhraseLen; ++idx1, ++idx2)
   {
      if (idx2 == ThisKeyLen)
         idx2 = 0;

      NewKey[idx1] = TempKey[idx2];
   }

   NewKey[idx1] = '\0';

//--- Do the Encryption or Decryption depending on the value of Type. Only
//--- characters between A-Z and a-z are transformed. The rest are left as is.

   switch (Type)
   {
      case CYPHER_ENC:
         for (idx1 = 0; idx1 < PhraseLen; ++idx1)
         {
            if ((Phrase[idx1] >= 'A') && (Phrase[idx1] <= 'Z'))
               EncryptedMsg[idx1] = ((Phrase[idx1] + NewKey[idx1]) % 26) + 'A';
            else if ((Phrase[idx1] >= 'a') && (Phrase[idx1] <= 'z'))
               EncryptedMsg[idx1] = ((Phrase[idx1] + NewKey[idx1]) % 26) + 'a';
            else
               EncryptedMsg[idx1] = Phrase[idx1];
         }
         EncryptedMsg[idx1] = '\0';
         break;

      case CYPHER_DEC:
         for (idx1 = 0; idx1 < PhraseLen; ++idx1)
         {
            if ((Phrase[idx1] >= 'A') && (Phrase[idx1] <= 'Z'))
               EncryptedMsg[idx1] = (((Phrase[idx1] - NewKey[idx1]) + 26) % 26) + 'A';
            else if ((Phrase[idx1] >= 'a') && (Phrase[idx1] <= 'z'))
               EncryptedMsg[idx1] = (((Phrase[idx1] - NewKey[idx1]) + 14) % 26) + 'a';
            else
               EncryptedMsg[idx1] = Phrase[idx1];
         }
         EncryptedMsg[idx1] = '\0';
         break;
   }

   ThisPhrase = EncryptedMsg;
   return(ThisPhrase);
}

//---------------------------------------------------------------------------
// Function to insert/remove special characters from lines inserted into and
// read from an XML file
//---------------------------------------------------------------------------
AnsiString __fastcall TFLPMS_FirstRunApp::ReplaceXML(AnsiString S1, int Type)
{
   if (Type == TYPE_READ)
   {
      S1 = AnsiReplaceStr(S1,"$quote;", "'");
      S1 = AnsiReplaceStr(S1,"$slash;", "\\");
      S1 = AnsiReplaceStr(S1,"$amp;",   "&");
      S1 = AnsiReplaceStr(S1,"$LeftA;", "<");
      S1 = AnsiReplaceStr(S1,"$RightA;",">");
      S1 = AnsiReplaceStr(S1,"##null##","");
      S1 = AnsiReplaceStr(S1,"µ",       "");    // Backup Manager on Linux
   }
   else
   {
      S1 = AnsiReplaceStr(S1,"'", "$quote;");
      S1 = AnsiReplaceStr(S1,"\\","$slash;");
      S1 = AnsiReplaceStr(S1,"&", "$amp;");
      S1 = AnsiReplaceStr(S1,"<", "$LeftA;");
      S1 = AnsiReplaceStr(S1,">", "$RightA;");

      if (S1.IsEmpty() == true)
         S1 = "##null##";
   }

   return(S1);
}

//---------------------------------------------------------------------------


